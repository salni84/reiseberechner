import * as tslib_1 from "tslib";
import { searchAndInitialize, preventDefault } from "../Utils";
import { empty, addClass, removeClass, hasClass } from "../DomFunctions";
import DomElement from "../DomElement";
import * as Inputs from "../Inputs";
var QUERY_DROPDOWN = ".js-autocomplete";
var CLASS_RESULT = "autocomplete__result";
var CLASS_OPEN = "is-open";
var CLASS_HOVER = "js-hover";
var ATTRIBUTE_VALUE = "data-value";
var TIMEOUT_BLUR = 400;
/**
 * Autocomplete component
 * @fires Autocomplete#change
 */
var Autocomplete = /** @class */ (function (_super) {
    tslib_1.__extends(Autocomplete, _super);
    function Autocomplete(element, configuration) {
        var _this = _super.call(this, element) || this;
        _this._input = _this.element.querySelector("input");
        _this._dropdown = _this.element.querySelector(QUERY_DROPDOWN);
        // Setup event context
        _this._clickHandler = _this._handleClick.bind(_this);
        _this._windowClickHandler = _this._handleWindowClick.bind(_this);
        _this._keyUpHandler = _this._handleKeyUp.bind(_this);
        _this._keyDownHandler = _this._handleKeyDown.bind(_this);
        _this._blurHandler = _this._handleBlur.bind(_this);
        if (configuration) {
            _this._minChars = configuration.minChars;
            _this._source = configuration.source;
        }
        if (!_this._minChars || _this._minChars < 0) {
            _this._minChars = 2;
        }
        _this._initialize();
        return _this;
    }
    /**
     * Initializes the Autocomplete component.
     * @private
     */
    Autocomplete.prototype._initialize = function () {
        this._clearSuggestions();
        if (this._input.getAttribute("disabled")) {
            this.disable();
        }
        else {
            this.enable();
        }
        // Disable browser autofill
        this._input.setAttribute("autocomplete", "off");
    };
    /**
     * The Autocomplete component configuration object
     * @callback Autocomplete~Suggest
     * @property {String} term - The current search term.
     * @property {String[]} matches - The list of matching strings.
     */
    /**
     * The Autocomplete component configuration object
     * @callback Autocomplete~Source
     * @property {String} term - The current search term.
     * @property {Autocomplete~Suggest} suggest - The autocomplete callback function to report the results.
     */
    /**
     * The Autocomplete component configuration object
     * @typedef {Object} Autocomplete~Config
     * @property {Number} minChars - The minimal required characters to start querying for autocomplete matches.
     * @property {Autocomplete~Source} source - The autocomplete source function.
     */
    /**
     * Updates the autocomplete component configuration for the current instance
     * @param {Autocomplete~Config} configuration The configuration object
     */
    Autocomplete.prototype.configure = function (configuration) {
        if (!configuration) {
            return;
        }
        if (configuration.minChars) {
            this._minChars = Math.min(configuration.minChars, 1);
        }
        if (configuration.source) {
            this._source = configuration.source;
        }
        this._clearSuggestions();
    };
    /**
     * Sets the select control to the enabled state.
     */
    Autocomplete.prototype.enable = function () {
        if (!this._input) {
            return;
        }
        this._input.removeAttribute("disabled");
        this._input.addEventListener("keyup", this._keyUpHandler);
        this._input.addEventListener("keydown", this._keyDownHandler);
        this._input.addEventListener("blur", this._blurHandler);
    };
    /**
     * Sets the select control to the disabled state.
     */
    Autocomplete.prototype.disable = function () {
        if (!this._input) {
            return;
        }
        this._input.setAttribute("disabled", "true");
        this._input.removeEventListener("keyup", this._keyUpHandler);
        this._input.removeEventListener("keydown", this._keyDownHandler);
        this._input.removeEventListener("blur", this._blurHandler);
        this.close();
    };
    /**
     * Destroys the component and frees all references.
     */
    Autocomplete.prototype.destroy = function () {
        this.disable();
        this._keyUpHandler = undefined;
        this._keyDownHandler = undefined;
        this._windowClickHandler = undefined;
        this._blurHandler = undefined;
        this._input = undefined;
    };
    /**
     * Closes the suggestions dropdown.
     */
    Autocomplete.prototype.open = function () {
        this._dropdown.addEventListener("click", this._clickHandler);
        window.addEventListener("click", this._windowClickHandler);
        this.addClass(CLASS_OPEN);
    };
    /**
     * Opens the suggestions dropdown.
     */
    Autocomplete.prototype.close = function () {
        this._dropdown.removeEventListener("click", this._clickHandler);
        window.removeEventListener("click", this._windowClickHandler);
        this.removeClass(CLASS_OPEN);
    };
    Object.defineProperty(Autocomplete.prototype, "value", {
        /**
         * Gets the value of the input field.
         * @returns {String} The value of the input field.
         */
        get: function () {
            return this._input.value;
        },
        enumerable: true,
        configurable: true
    });
    Autocomplete.prototype._handleClick = function (event) {
        if (!this._isDropdownTarget(event.target)) {
            return;
        }
        var current = event.target;
        while (current.nodeName !== "LI" && current.parentNode) {
            current = current.parentNode;
        }
        if (current.nodeName === "LI") {
            preventDefault(event);
            this._selectItem(current);
        }
    };
    Autocomplete.prototype._handleBlur = function () {
        var _this = this;
        setTimeout(function () {
            _this.close();
        }, TIMEOUT_BLUR);
    };
    Autocomplete.prototype._handleKeyUp = function (evt) {
        var keycode = evt.which || evt.keyCode;
        if (Inputs.containsKey(keycode, [Inputs.KEY_ARROW_UP, Inputs.KEY_ARROW_DOWN, Inputs.KEY_ENTER, Inputs.KEY_TAB])) {
            // Do not handle these events on keyup
            preventDefault(evt);
            return;
        }
        var target = evt.currentTarget;
        if (evt.currentTarget && target.value && target.value.length >= this._minChars) {
            this._getSuggestion(target.value);
        }
        else {
            this.close();
        }
    };
    Autocomplete.prototype._handleKeyDown = function (evt) {
        var keycode = evt.which || evt.keyCode;
        var isOpen = hasClass(this.element, CLASS_OPEN);
        if (keycode === Inputs.KEY_ESCAPE && isOpen === true) {
            // handle Escape key (ESC)
            this.close();
            preventDefault(evt);
            return;
        }
        if (isOpen === true && Inputs.containsKey(keycode, [Inputs.KEY_ENTER, Inputs.KEY_TAB])) {
            var focusedElement = this._suggestionList.querySelector("." + CLASS_HOVER);
            preventDefault(evt);
            this._selectItem(focusedElement);
            return;
        }
        if (isOpen === true && Inputs.containsKey(keycode, [Inputs.KEY_ARROW_UP, Inputs.KEY_ARROW_DOWN])) {
            // Up and down arrows
            var focusedElement = this._suggestionList.querySelector("." + CLASS_HOVER);
            if (focusedElement) {
                removeClass(focusedElement, CLASS_HOVER);
                var children = Array.prototype.slice.call(this._suggestionList.childNodes);
                var totalNodes = children.length - 1;
                var direction = keycode === Inputs.KEY_ARROW_UP ? -1 : 1;
                var index = children.indexOf(focusedElement);
                index = Math.max(Math.min(index + direction, totalNodes), 0);
                focusedElement = this._suggestionList.childNodes[index];
            }
            else {
                focusedElement = this._suggestionList.querySelector("li");
            }
            addClass(focusedElement, CLASS_HOVER);
            preventDefault(evt);
            return;
        }
    };
    Autocomplete.prototype._handleWindowClick = function (event) {
        if (this._isDropdownTarget(event.target)) {
            return;
        }
        this.close();
    };
    Autocomplete.prototype._selectItem = function (item) {
        if (!item) {
            return;
        }
        var text = item.getAttribute(ATTRIBUTE_VALUE);
        if (text) {
            this._input.value = text;
            // Dispatch the changed event
            this.dispatchEvent("change");
        }
        this.close();
    };
    Autocomplete.prototype._isDropdownTarget = function (target) {
        var current = target;
        while (current !== this._dropdown && current.parentNode) {
            current = current.parentNode;
        }
        return current === this._dropdown;
    };
    Autocomplete.prototype._clearSuggestions = function () {
        // Clear the dropdown item
        empty(this._dropdown);
        this._suggestionList = document.createElement("ul");
        this._dropdown.appendChild(this._suggestionList);
    };
    Autocomplete.prototype._addSuggestion = function (text, term) {
        var sanitizedTerm = term.replace(/[-\\^$*+?.()|[\]{}]/g, "\\$&");
        var html = text.replace(new RegExp("(" + sanitizedTerm + ")", "gi"), "<strong>$1</strong>");
        var textElement = new DomElement("span")
            .setHtml(html);
        var innerElement = new DomElement("div")
            .addClass(CLASS_RESULT)
            .appendChild(textElement);
        var liElement = new DomElement("li")
            .setAttribute(ATTRIBUTE_VALUE, text)
            .appendChild(innerElement);
        this._suggestionList.appendChild(liElement.element);
    };
    Autocomplete.prototype._getSuggestion = function (term) {
        var _this = this;
        if (!this._source) {
            throw new Error("The source function is undefined, cannot load suggestions");
        }
        this._source(term, function (matches, termused) {
            _this._onMatchesReceived(matches, termused);
        });
    };
    Autocomplete.prototype._onMatchesReceived = function (matches, term) {
        var e_1, _a;
        this._clearSuggestions();
        if (!matches || matches.length === 0) {
            this.close();
        }
        else {
            // Clear the dropdown item
            empty(this._suggestionList);
            try {
                for (var matches_1 = tslib_1.__values(matches), matches_1_1 = matches_1.next(); !matches_1_1.done; matches_1_1 = matches_1.next()) {
                    var match = matches_1_1.value;
                    this._addSuggestion(match, term);
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (matches_1_1 && !matches_1_1.done && (_a = matches_1.return)) _a.call(matches_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
            this.open();
        }
    };
    return Autocomplete;
}(DomElement));
/**
 * Change event
 *
 * @event Autocomplete#change
 * @type {object}
 */
export function init() {
    searchAndInitialize(".input-field--autocomplete", function (e) {
        new Autocomplete(e);
    });
}
export default Autocomplete;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4vc3JjL2Zvcm0vQXV0b2NvbXBsZXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsY0FBYyxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQzlELE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTtBQUN4RSxPQUFPLFVBQVUsTUFBTSxlQUFlLENBQUE7QUFDdEMsT0FBTyxLQUFLLE1BQU0sTUFBTSxXQUFXLENBQUE7QUFFbkMsSUFBTSxjQUFjLEdBQUcsa0JBQWtCLENBQUE7QUFDekMsSUFBTSxZQUFZLEdBQUcsc0JBQXNCLENBQUE7QUFDM0MsSUFBTSxVQUFVLEdBQUcsU0FBUyxDQUFBO0FBQzVCLElBQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQTtBQUM5QixJQUFNLGVBQWUsR0FBRyxZQUFZLENBQUE7QUFFcEMsSUFBTSxZQUFZLEdBQUcsR0FBRyxDQUFBO0FBY3hCOzs7R0FHRztBQUNIO0lBQTJCLHdDQUF1QjtJQWNoRCxzQkFBWSxPQUFvQixFQUFFLGFBQWtDO1FBQXBFLFlBQ0Usa0JBQU0sT0FBTyxDQUFDLFNBc0JmO1FBcEJDLEtBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFFLENBQUE7UUFDbEQsS0FBSSxDQUFDLFNBQVMsR0FBRyxLQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQWlCLENBQUE7UUFFM0Usc0JBQXNCO1FBQ3RCLEtBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLENBQUE7UUFDakQsS0FBSSxDQUFDLG1CQUFtQixHQUFHLEtBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLENBQUE7UUFDN0QsS0FBSSxDQUFDLGFBQWEsR0FBRyxLQUFJLENBQUMsWUFBWSxD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QUksQ0FBQyxJQUFJLEVBQUUsQ0FBQTtTQUNaO0lBQ0gsQ0FBQztJQUNILG1CQUFDO0FBQUQsQ0F0VkEsQUFzVkMsQ0F0VjBCLFVBQVUsR0FzVnBDO0FBRUQ7Ozs7O0dBS0c7QUFFSCxNQUFNLFVBQVUsSUFBSTtJQUNsQixtQkFBbUIsQ0FBYyw0QkFBNEIsRUFBRSxVQUFDLENBQUM7UUFDL0QsSUFBSSxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDckIsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQsZUFBZSxZQUFZLENBQUEiLCJmaWxlIjoibWFpbi9zcmMvZm9ybS9BdXRvY29tcGxldGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzZWFyY2hBbmRJbml0aWFsaXplLCBwcmV2ZW50RGVmYXVsdCB9IGZyb20gXCIuLi9VdGlsc1wiXG5pbXBvcnQgeyBlbXB0eSwgYWRkQ2xhc3MsIHJlbW92ZUNsYXNzLCBoYXNDbGFzcyB9IGZyb20gXCIuLi9Eb21GdW5jdGlvbnNcIlxuaW1wb3J0IERvbUVsZW1lbnQgZnJvbSBcIi4uL0RvbUVsZW1lbnRcIlxuaW1wb3J0ICogYXMgSW5wdXRzIGZyb20gXCIuLi9JbnB1dHNcIlxuXG5jb25zdCBRVUVSWV9EUk9QRE9XTiA9IFwiLmpzLWF1dG9jb21wbGV0ZVwiXG5jb25zdCBDTEFTU19SRVNVTFQgPSBcImF1dG9jb21wbGV0ZV9fcmVzdWx0XCJcbmNvbnN0IENMQVNTX09QRU4gPSBcImlzLW9wZW5cIlxuY29uc3QgQ0xBU1NfSE9WRVIgPSBcImpzLWhvdmVyXCJcbmNvbnN0IEFUVFJJQlVURV9WQUxVRSA9IFwiZGF0YS12YWx1ZVwiXG5cbmNvbnN0IFRJTUVPVVRfQkxVUiA9IDQwMFxuXG5leHBvcnQgaW50ZXJmYWNlIFNvdXJjZSB7XG4gIChcbiAgICB0ZXJtOiBzdHJpbmcsXG4gICAgY2FsbGJhY2s6IChtYXRjaGVzOiBzdHJpbmdbXSwgdGVybXVzZWQ6IHN0cmluZykgPT4gdm9pZFxuICApOiB2b2lkXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0b2NvbXBsZXRlQ29uZmlnIHtcbiAgbWluQ2hhcnM6IG51bWJlclxuICBzb3VyY2U6IFNvdXJjZVxufVxuXG4vKipcbiAqIEF1dG9jb21wbGV0ZSBjb21wb25lbnRcbiAqIEBmaXJlcyBBdXRvY29tcGxldGUjY2hhbmdlXG4gKi9cbmNsYXNzIEF1dG9jb21wbGV0ZSBleHRlbmRzIERvbUVsZW1lbnQ8SFRNTEVsZW1lbnQ+IHtcbiAgcHJpdmF0ZSBfc291cmNlITogU291cmNlXG4gIHByaXZhdGUgX21pbkNoYXJzITogbnVtYmVyXG5cbiAgcHJpdmF0ZSBfaW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnRcbiAgcHJpdmF0ZSBfc3VnZ2VzdGlvbkxpc3QhOiBIVE1MVUxpc3RFbGVtZW50XG4gIHByaXZhdGUgX2Ryb3Bkb3duOiBIVE1MRWxlbWVudFxuXG4gIHByaXZhdGUgX2NsaWNrSGFuZGxlcjogKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB2b2lkXG4gIHByaXZhdGUgX3dpbmRvd0NsaWNrSGFuZGxlcjogKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB2b2lkXG4gIHByaXZhdGUgX2tleVVwSGFuZGxlcjogKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB2b2lkXG4gIHByaXZhdGUgX2tleURvd25IYW5kbGVyOiAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpID0+IHZvaWRcbiAgcHJpdmF0ZSBfYmx1ckhhbmRsZXI6IChldmVudDogRXZlbnQpID0+IHZvaWRcblxuICBjb25zdHJ1Y3RvcihlbGVtZW50OiBIVE1MRWxlbWVudCwgY29uZmlndXJhdGlvbj86IEF1dG9jb21wbGV0ZUNvbmZpZykge1xuICAgIHN1cGVyKGVsZW1lbnQpXG5cbiAgICB0aGlzLl9pbnB1dCA9IHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yKFwiaW5wdXRcIikhXG4gICAgdGhpcy5fZHJvcGRvd24gPSB0aGlzLmVsZW1lbnQucXVlcnlTZWxlY3RvcihRVUVSWV9EUk9QRE9XTikhIGFzIEhUTUxFbGVtZW50XG5cbiAgICAvLyBTZXR1cCBldmVudCBjb250ZXh0XG4gICAgdGhpcy5fY2xpY2tIYW5kbGVyID0gdGhpcy5faGFuZGxlQ2xpY2suYmluZCh0aGlzKVxuICAgIHRoaXMuX3dpbmRvd0NsaWNrSGFuZGxlciA9IHRoaXMuX2hhbmRsZVdpbmRvd0NsaWNrLmJpbmQodGhpcylcbiAgICB0aGlzLl9rZXlVcEhhbmRsZXIgPSB0aGlzLl9oYW5kbGVLZXlVcC5iaW5kKHRoaXMpXG4gICAgdGhpcy5fa2V5RG93bkhhbmRsZXIgPSB0aGlzLl9oYW5kbGVLZXlEb3duLmJpbmQodGhpcylcbiAgICB0aGlzLl9ibHVySGFuZGxlciA9IHRoaXMuX2hhbmRsZUJsdXIuYmluZCh0aGlzKVxuXG4gICAgaWYgKGNvbmZpZ3VyYXRpb24pIHtcbiAgICAgIHRoaXMuX21pbkNoYXJzID0gY29uZmlndXJhdGlvbi5taW5DaGFyc1xuICAgICAgdGhpcy5fc291cmNlID0gY29uZmlndXJhdGlvbi5zb3VyY2VcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuX21pbkNoYXJzIHx8IHRoaXMuX21pbkNoYXJzIDwgMCkge1xuICAgICAgdGhpcy5fbWluQ2hhcnMgPSAyXG4gICAgfVxuXG4gICAgdGhpcy5faW5pdGlhbGl6ZSgpXG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZXMgdGhlIEF1dG9jb21wbGV0ZSBjb21wb25lbnQuXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBwcm90ZWN0ZWQgX2luaXRpYWxpemUoKSB7XG4gICAgdGhpcy5fY2xlYXJTdWdnZXN0aW9ucygpXG5cbiAgICBpZiAodGhpcy5faW5wdXQuZ2V0QXR0cmlidXRlKFwiZGlzYWJsZWRcIikpIHtcbiAgICAgIHRoaXMuZGlzYWJsZSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZW5hYmxlKClcbiAgICB9XG5cbiAgICAvLyBEaXNhYmxlIGJyb3dzZXIgYXV0b2ZpbGxcbiAgICB0aGlzLl9pbnB1dC5zZXRBdHRyaWJ1dGUoXCJhdXRvY29tcGxldGVcIiwgXCJvZmZcIilcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgQXV0b2NvbXBsZXRlIGNvbXBvbmVudCBjb25maWd1cmF0aW9uIG9iamVjdFxuICAgKiBAY2FsbGJhY2sgQXV0b2NvbXBsZXRlflN1Z2dlc3RcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IHRlcm0gLSBUaGUgY3VycmVudCBzZWFyY2ggdGVybS5cbiAgICogQHByb3BlcnR5IHtTdHJpbmdbXX0gbWF0Y2hlcyAtIFRoZSBsaXN0IG9mIG1hdGNoaW5nIHN0cmluZ3MuXG4gICAqL1xuXG4gIC8qKlxuICAgKiBUaGUgQXV0b2NvbXBsZXRlIGNvbXBvbmVudCBjb25maWd1cmF0aW9uIG9iamVjdFxuICAgKiBAY2FsbGJhY2sgQXV0b2NvbXBsZXRlflNvdXJjZVxuICAgKiBAcHJvcGVydHkge1N0cmluZ30gdGVybSAtIFRoZSBjdXJyZW50IHNlYXJjaCB0ZXJtLlxuICAgKiBAcHJvcGVydHkge0F1dG9jb21wbGV0ZX5TdWdnZXN0fSBzdWdnZXN0IC0gVGhlIGF1dG9jb21wbGV0ZSBjYWxsYmFjayBmdW5jdGlvbiB0byByZXBvcnQgdGhlIHJlc3VsdHMuXG4gICAqL1xuXG4gIC8qKlxuICAgKiBUaGUgQXV0b2NvbXBsZXRlIGNvbXBvbmVudCBjb25maWd1cmF0aW9uIG9iamVjdFxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBBdXRvY29tcGxldGV+Q29uZmlnXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBtaW5DaGFycyAtIFRoZSBtaW5pbWFsIHJlcXVpcmVkIGNoYXJhY3RlcnMgdG8gc3RhcnQgcXVlcnlpbmcgZm9yIGF1dG9jb21wbGV0ZSBtYXRjaGVzLlxuICAgKiBAcHJvcGVydHkge0F1dG9jb21wbGV0ZX5Tb3VyY2V9IHNvdXJjZSAtIFRoZSBhdXRvY29tcGxldGUgc291cmNlIGZ1bmN0aW9uLlxuICAgKi9cblxuICAvKipcbiAgICogVXBkYXRlcyB0aGUgYXV0b2NvbXBsZXRlIGNvbXBvbmVudCBjb25maWd1cmF0aW9uIGZvciB0aGUgY3VycmVudCBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge0F1dG9jb21wbGV0ZX5Db25maWd9IGNvbmZpZ3VyYXRpb24gVGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0XG4gICAqL1xuICBwdWJsaWMgY29uZmlndXJlKGNvbmZpZ3VyYXRpb24/OiBBdXRvY29tcGxldGVDb25maWcpIHtcbiAgICBpZiAoIWNvbmZpZ3VyYXRpb24pIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGlmIChjb25maWd1cmF0aW9uLm1pbkNoYXJzKSB7XG4gICAgICB0aGlzLl9taW5DaGFycyA9IE1hdGgubWluKGNvbmZpZ3VyYXRpb24ubWluQ2hhcnMsIDEpXG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZ3VyYXRpb24uc291cmNlKSB7XG4gICAgICB0aGlzLl9zb3VyY2UgPSBjb25maWd1cmF0aW9uLnNvdXJjZVxuICAgIH1cblxuICAgIHRoaXMuX2NsZWFyU3VnZ2VzdGlvbnMoKVxuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIHNlbGVjdCBjb250cm9sIHRvIHRoZSBlbmFibGVkIHN0YXRlLlxuICAgKi9cbiAgcHVibGljIGVuYWJsZSgpIHtcbiAgICBpZiAoIXRoaXMuX2lucHV0KSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0aGlzLl9pbnB1dC5yZW1vdmVBdHRyaWJ1dGUoXCJkaXNhYmxlZFwiKVxuXG4gICAgdGhpcy5faW5wdXQuYWRkRXZlbnRMaXN0ZW5lcihcImtleXVwXCIsIHRoaXMuX2tleVVwSGFuZGxlcilcbiAgICB0aGlzLl9pbnB1dC5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCB0aGlzLl9rZXlEb3duSGFuZGxlcilcbiAgICB0aGlzLl9pbnB1dC5hZGRFdmVudExpc3RlbmVyKFwiYmx1clwiLCB0aGlzLl9ibHVySGFuZGxlcilcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBzZWxlY3QgY29udHJvbCB0byB0aGUgZGlzYWJsZWQgc3RhdGUuXG4gICAqL1xuICBwdWJsaWMgZGlzYWJsZSgpIHtcbiAgICBpZiAoIXRoaXMuX2lucHV0KSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0aGlzLl9pbnB1dC5zZXRBdHRyaWJ1dGUoXCJkaXNhYmxlZFwiLCBcInRydWVcIilcblxuICAgIHRoaXMuX2lucHV0LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJrZXl1cFwiLCB0aGlzLl9rZXlVcEhhbmRsZXIpXG4gICAgdGhpcy5faW5wdXQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgdGhpcy5fa2V5RG93bkhhbmRsZXIpXG4gICAgdGhpcy5faW5wdXQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImJsdXJcIiwgdGhpcy5fYmx1ckhhbmRsZXIpXG5cbiAgICB0aGlzLmNsb3NlKClcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXN0cm95cyB0aGUgY29tcG9uZW50IGFuZCBmcmVlcyBhbGwgcmVmZXJlbmNlcy5cbiAgICovXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIHRoaXMuZGlzYWJsZSgpO1xuXG4gICAgKHRoaXMgYXMgYW55KS5fa2V5VXBIYW5kbGVyID0gdW5kZWZpbmVkO1xuICAgICh0aGlzIGFzIGFueSkuX2tleURvd25IYW5kbGVyID0gdW5kZWZpbmVkO1xuICAgICh0aGlzIGFzIGFueSkuX3dpbmRvd0NsaWNrSGFuZGxlciA9IHVuZGVmaW5lZDtcbiAgICAodGhpcyBhcyBhbnkpLl9ibHVySGFuZGxlciA9IHVuZGVmaW5lZDtcblxuICAgICh0aGlzIGFzIGFueSkuX2lucHV0ID0gdW5kZWZpbmVkXG4gIH1cblxuICAvKipcbiAgICogQ2xvc2VzIHRoZSBzdWdnZXN0aW9ucyBkcm9wZG93bi5cbiAgICovXG4gIHB1YmxpYyBvcGVuKCkge1xuICAgIHRoaXMuX2Ryb3Bkb3duLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCB0aGlzLl9jbGlja0hhbmRsZXIpXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCB0aGlzLl93aW5kb3dDbGlja0hhbmRsZXIpXG5cbiAgICB0aGlzLmFkZENsYXNzKENMQVNTX09QRU4pXG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgdGhlIHN1Z2dlc3Rpb25zIGRyb3Bkb3duLlxuICAgKi9cbiAgcHVibGljIGNsb3NlKCkge1xuICAgIHRoaXMuX2Ryb3Bkb3duLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCB0aGlzLl9jbGlja0hhbmRsZXIpXG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCB0aGlzLl93aW5kb3dDbGlja0hhbmRsZXIpXG5cbiAgICB0aGlzLnJlbW92ZUNsYXNzKENMQVNTX09QRU4pXG4gIH1cblxuICAvKipcbiAgICogR2V0cyB0aGUgdmFsdWUgb2YgdGhlIGlucHV0IGZpZWxkLlxuICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgdmFsdWUgb2YgdGhlIGlucHV0IGZpZWxkLlxuICAgKi9cbiAgZ2V0IHZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLl9pbnB1dC52YWx1ZVxuICB9XG5cbiAgcHJvdGVjdGVkIF9oYW5kbGVDbGljayhldmVudDogTW91c2VFdmVudCkge1xuICAgIGlmICghdGhpcy5faXNEcm9wZG93blRhcmdldChldmVudC50YXJnZXQgYXMgTm9kZSkpIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGxldCBjdXJyZW50ID0gZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50XG4gICAgd2hpbGUgKGN1cnJlbnQubm9kZU5hbWUgIT09IFwiTElcIiAmJiBjdXJyZW50LnBhcmVudE5vZGUpIHtcbiAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnBhcmVudE5vZGUgYXMgSFRNTEVsZW1lbnRcbiAgICB9XG5cbiAgICBpZiAoY3VycmVudC5ub2RlTmFtZSA9PT0gXCJMSVwiKSB7XG4gICAgICBwcmV2ZW50RGVmYXVsdChldmVudClcbiAgICAgIHRoaXMuX3NlbGVjdEl0ZW0oY3VycmVudClcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgX2hhbmRsZUJsdXIoKSB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmNsb3NlKClcbiAgICB9LCBUSU1FT1VUX0JMVVIpXG4gIH1cblxuICBwcm90ZWN0ZWQgX2hhbmRsZUtleVVwKGV2dDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGxldCBrZXljb2RlID0gZXZ0LndoaWNoIHx8IGV2dC5rZXlDb2RlXG5cbiAgICBpZiAoSW5wdXRzLmNvbnRhaW5zS2V5KGtleWNvZGUsIFsgSW5wdXRzLktFWV9BUlJPV19VUCwgSW5wdXRzLktFWV9BUlJPV19ET1dOLCBJbnB1dHMuS0VZX0VOVEVSLCBJbnB1dHMuS0VZX1RBQiBdKSkge1xuICAgICAgLy8gRG8gbm90IGhhbmRsZSB0aGVzZSBldmVudHMgb24ga2V5dXBcbiAgICAgIHByZXZlbnREZWZhdWx0KGV2dClcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IHRhcmdldCA9IGV2dC5jdXJyZW50VGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnRcblxuICAgIGlmIChldnQuY3VycmVudFRhcmdldCAmJiB0YXJnZXQudmFsdWUgJiYgdGFyZ2V0LnZhbHVlLmxlbmd0aCA+PSB0aGlzLl9taW5DaGFycykge1xuICAgICAgdGhpcy5fZ2V0U3VnZ2VzdGlvbih0YXJnZXQudmFsdWUpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2xvc2UoKVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBfaGFuZGxlS2V5RG93bihldnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICBsZXQga2V5Y29kZSA9IGV2dC53aGljaCB8fCBldnQua2V5Q29kZVxuICAgIGNvbnN0IGlzT3BlbiA9IGhhc0NsYXNzKHRoaXMuZWxlbWVudCwgQ0xBU1NfT1BFTilcblxuICAgIGlmIChrZXljb2RlID09PSBJbnB1dHMuS0VZX0VTQ0FQRSAmJiBpc09wZW4gPT09IHRydWUpIHtcbiAgICAgIC8vIGhhbmRsZSBFc2NhcGUga2V5IChFU0MpXG4gICAgICB0aGlzLmNsb3NlKClcbiAgICAgIHByZXZlbnREZWZhdWx0KGV2dClcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGlmIChpc09wZW4gPT09IHRydWUgJiYgSW5wdXRzLmNvbnRhaW5zS2V5KGtleWNvZGUsIFsgSW5wdXRzLktFWV9FTlRFUiwgSW5wdXRzLktFWV9UQUIgXSkpIHtcbiAgICAgIGxldCBmb2N1c2VkRWxlbWVudCA9IHRoaXMuX3N1Z2dlc3Rpb25MaXN0LnF1ZXJ5U2VsZWN0b3IoYC4ke0NMQVNTX0hPVkVSfWApXG5cbiAgICAgIHByZXZlbnREZWZhdWx0KGV2dClcbiAgICAgIHRoaXMuX3NlbGVjdEl0ZW0oZm9jdXNlZEVsZW1lbnQpXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBpZiAoaXNPcGVuID09PSB0cnVlICYmIElucHV0cy5jb250YWluc0tleShrZXljb2RlLCBbIElucHV0cy5LRVlfQVJST1dfVVAsIElucHV0cy5LRVlfQVJST1dfRE9XTiBdKSkge1xuICAgICAgLy8gVXAgYW5kIGRvd24gYXJyb3dzXG5cbiAgICAgIGxldCBmb2N1c2VkRWxlbWVudCA9IHRoaXMuX3N1Z2dlc3Rpb25MaXN0LnF1ZXJ5U2VsZWN0b3IoYC4ke0NMQVNTX0hPVkVSfWApIVxuICAgICAgaWYgKGZvY3VzZWRFbGVtZW50KSB7XG4gICAgICAgIHJlbW92ZUNsYXNzKGZvY3VzZWRFbGVtZW50LCBDTEFTU19IT1ZFUilcblxuICAgICAgICBjb25zdCBjaGlsZHJlbiA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHRoaXMuX3N1Z2dlc3Rpb25MaXN0LmNoaWxkTm9kZXMpIGFzIEVsZW1lbnRbXVxuXG4gICAgICAgIGNvbnN0IHRvdGFsTm9kZXMgPSBjaGlsZHJlbi5sZW5ndGggLSAxXG4gICAgICAgIGNvbnN0IGRpcmVjdGlvbiA9IGtleWNvZGUgPT09IElucHV0cy5LRVlfQVJST1dfVVAgPyAtMSA6IDFcblxuICAgICAgICBsZXQgaW5kZXggPSBjaGlsZHJlbi5pbmRleE9mKGZvY3VzZWRFbGVtZW50KVxuXG4gICAgICAgIGluZGV4ID0gTWF0aC5tYXgoTWF0aC5taW4oaW5kZXggKyBkaXJlY3Rpb24sIHRvdGFsTm9kZXMpLCAwKVxuICAgICAgICBmb2N1c2VkRWxlbWVudCA9IHRoaXMuX3N1Z2dlc3Rpb25MaXN0LmNoaWxkTm9kZXNbaW5kZXhdIGFzIEVsZW1lbnRcblxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZm9jdXNlZEVsZW1lbnQgPSB0aGlzLl9zdWdnZXN0aW9uTGlzdC5xdWVyeVNlbGVjdG9yKFwibGlcIikgYXMgRWxlbWVudFxuICAgICAgfVxuXG4gICAgICBhZGRDbGFzcyhmb2N1c2VkRWxlbWVudCwgQ0xBU1NfSE9WRVIpXG4gICAgICBwcmV2ZW50RGVmYXVsdChldnQpXG4gICAgICByZXR1cm5cbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgX2hhbmRsZVdpbmRvd0NsaWNrKGV2ZW50OiBNb3VzZUV2ZW50KSB7XG4gICAgaWYgKHRoaXMuX2lzRHJvcGRvd25UYXJnZXQoZXZlbnQudGFyZ2V0IGFzIE5vZGUpKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0aGlzLmNsb3NlKClcbiAgfVxuXG4gIHByb3RlY3RlZCBfc2VsZWN0SXRlbShpdGVtPzogRWxlbWVudCB8IG51bGwpIHtcbiAgICBpZiAoIWl0ZW0pIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IHRleHQgPSBpdGVtLmdldEF0dHJpYnV0ZShBVFRSSUJVVEVfVkFMVUUpXG4gICAgaWYgKHRleHQpIHtcbiAgICAgIHRoaXMuX2lucHV0LnZhbHVlID0gdGV4dFxuXG4gICAgICAvLyBEaXNwYXRjaCB0aGUgY2hhbmdlZCBldmVudFxuICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KFwiY2hhbmdlXCIpXG4gICAgfVxuXG4gICAgdGhpcy5jbG9zZSgpXG4gIH1cblxuICBwcm90ZWN0ZWQgX2lzRHJvcGRvd25UYXJnZXQodGFyZ2V0OiBOb2RlKSB7XG4gICAgbGV0IGN1cnJlbnQgPSB0YXJnZXRcbiAgICB3aGlsZSAoY3VycmVudCAhPT0gdGhpcy5fZHJvcGRvd24gJiYgY3VycmVudC5wYXJlbnROb2RlKSB7XG4gICAgICBjdXJyZW50ID0gY3VycmVudC5wYXJlbnROb2RlXG4gICAgfVxuXG4gICAgcmV0dXJuIGN1cnJlbnQgPT09IHRoaXMuX2Ryb3Bkb3duXG4gIH1cblxuICBwcm90ZWN0ZWQgX2NsZWFyU3VnZ2VzdGlvbnMoKSB7XG4gICAgLy8gQ2xlYXIgdGhlIGRyb3Bkb3duIGl0ZW1cbiAgICBlbXB0eSh0aGlzLl9kcm9wZG93bilcblxuICAgIHRoaXMuX3N1Z2dlc3Rpb25MaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInVsXCIpXG4gICAgdGhpcy5fZHJvcGRvd24uYXBwZW5kQ2hpbGQodGhpcy5fc3VnZ2VzdGlvbkxpc3QpXG4gIH1cblxuICBwcm90ZWN0ZWQgX2FkZFN1Z2dlc3Rpb24odGV4dDogc3RyaW5nLCB0ZXJtOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzYW5pdGl6ZWRUZXJtID0gdGVybS5yZXBsYWNlKC9bLVxcXFxeJCorPy4oKXxbXFxde31dL2csIFwiXFxcXCQmXCIpXG4gICAgY29uc3QgaHRtbCA9IHRleHQucmVwbGFjZShuZXcgUmVnRXhwKGAoJHtzYW5pdGl6ZWRUZXJtfSlgLCBcImdpXCIpLCBcIjxzdHJvbmc+JDE8L3N0cm9uZz5cIilcblxuICAgIGNvbnN0IHRleHRFbGVtZW50ID0gbmV3IERvbUVsZW1lbnQoXCJzcGFuXCIpXG4gICAgICAuc2V0SHRtbChodG1sKVxuXG4gICAgY29uc3QgaW5uZXJFbGVtZW50ID0gbmV3IERvbUVsZW1lbnQoXCJkaXZcIilcbiAgICAgIC5hZGRDbGFzcyhDTEFTU19SRVNVTFQpXG4gICAgICAuYXBwZW5kQ2hpbGQodGV4dEVsZW1lbnQpXG5cbiAgICBjb25zdCBsaUVsZW1lbnQgPSBuZXcgRG9tRWxlbWVudChcImxpXCIpXG4gICAgICAuc2V0QXR0cmlidXRlKEFUVFJJQlVURV9WQUxVRSwgdGV4dClcbiAgICAgIC5hcHBlbmRDaGlsZChpbm5lckVsZW1lbnQpXG5cbiAgICB0aGlzLl9zdWdnZXN0aW9uTGlzdC5hcHBlbmRDaGlsZChsaUVsZW1lbnQuZWxlbWVudClcbiAgfVxuXG4gIHByb3RlY3RlZCBfZ2V0U3VnZ2VzdGlvbih0ZXJtOiBzdHJpbmcpIHtcbiAgICBpZiAoIXRoaXMuX3NvdXJjZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVGhlIHNvdXJjZSBmdW5jdGlvbiBpcyB1bmRlZmluZWQsIGNhbm5vdCBsb2FkIHN1Z2dlc3Rpb25zXCIpXG4gICAgfVxuXG4gICAgdGhpcy5fc291cmNlKHRlcm0sIChtYXRjaGVzLCB0ZXJtdXNlZCkgPT4ge1xuICAgICAgdGhpcy5fb25NYXRjaGVzUmVjZWl2ZWQobWF0Y2hlcywgdGVybXVzZWQpXG4gICAgfSlcbiAgfVxuXG4gIHByb3RlY3RlZCBfb25NYXRjaGVzUmVjZWl2ZWQobWF0Y2hlczogc3RyaW5nW10sIHRlcm06IHN0cmluZykge1xuICAgIHRoaXMuX2NsZWFyU3VnZ2VzdGlvbnMoKVxuXG4gICAgaWYgKCFtYXRjaGVzIHx8IG1hdGNoZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLmNsb3NlKClcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ2xlYXIgdGhlIGRyb3Bkb3duIGl0ZW1cbiAgICAgIGVtcHR5KHRoaXMuX3N1Z2dlc3Rpb25MaXN0KVxuXG4gICAgICBmb3IgKGxldCBtYXRjaCBvZiBtYXRjaGVzKSB7XG4gICAgICAgIHRoaXMuX2FkZFN1Z2dlc3Rpb24obWF0Y2gsIHRlcm0pXG4gICAgICB9XG5cbiAgICAgIHRoaXMub3BlbigpXG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQ2hhbmdlIGV2ZW50XG4gKlxuICogQGV2ZW50IEF1dG9jb21wbGV0ZSNjaGFuZ2VcbiAqIEB0eXBlIHtvYmplY3R9XG4gKi9cblxuZXhwb3J0IGZ1bmN0aW9uIGluaXQoKSB7XG4gIHNlYXJjaEFuZEluaXRpYWxpemU8SFRNTEVsZW1lbnQ+KFwiLmlucHV0LWZpZWxkLS1hdXRvY29tcGxldGVcIiwgKGUpID0+IHtcbiAgICBuZXcgQXV0b2NvbXBsZXRlKGUpXG4gIH0pXG59XG5cbmV4cG9ydCBkZWZhdWx0IEF1dG9jb21wbGV0ZVxuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLi8uLiJ9
