import * as tslib_1 from "tslib";
import { searchAndInitialize } from "../Utils";
import anime from "animejs";
import DomElement from "../DomElement";
import * as Dom from "../DomFunctions";
var QUERY_TOGGLE = ".accordion__toggle";
var QUERY_OPEN_SECTION = ".accordion__item.is-open";
var QUERY_COLLAPSE = ".accordion__collapse";
var CLASS_ITEM = "accordion__item";
var CLASS_OPEN = "is-open";
var CLASS_KEEP_OPEN = "accordion__keep-open";
var REGEX_HIDDEN = /accordion--hidden-.*/;
var ANIMATION_OPEN = 300;
var ANIMATION_DELAY_OPEN = 50;
var ANIMATION_VISIBLE = 150;
/**
 * The Accordion component
 */
var Accordion = /** @class */ (function (_super) {
    tslib_1.__extends(Accordion, _super);
    /**
     * Creates and initializes the Accordion component.
     * @param {DomElement} - The root element of the Accordion component.
     */
    function Accordion(element) {
        var _this = _super.call(this, element) || this;
        _this._sectionClickHandler = _this._handleSectionClick.bind(_this);
        _this._initialize();
        return _this;
    }
    /**
     * Initializes the Accordion component.
     * @private
     */
    Accordion.prototype._initialize = function () {
        var e_1, _a;
        if (this.element.className.split(" ").some(function (c) { return REGEX_HIDDEN.test(c); })) {
            var indicator = new DomElement("input")
                .setAttribute("type", "hidden")
                .addClass("js-hidden");
            this.appendChild(indicator);
            this._hiddenIndicator = indicator.element;
        }
        try {
            for (var _b = tslib_1.__values(this.element.querySelectorAll(QUERY_TOGGLE)), _c = _b.next(); !_c.done; _c = _b.next()) {
                var toggle = _c.value;
                toggle.addEventListener("click", this._sectionClickHandler);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
    };
    Accordion.prototype._handleSectionClick = function (event) {
        if (this._hiddenIndicator) {
            var style = window.getComputedStyle(this._hiddenIndicator);
            if (style.visibility !== "visible") {
                return;
            }
        }
        var navSection = event.target.parentElement;
        while (!Dom.hasClass(navSection, CLASS_ITEM) && navSection.parentElement) {
            navSection = navSection.parentElement;
        }
        var prevSection = this.element.querySelector(QUERY_OPEN_SECTION);
        if (prevSection && prevSection !== navSection) {
            if (!Dom.hasClass(this.element, CLASS_KEEP_OPEN)) {
                this._toggleSection(prevSection);
            }
        }
        this._toggleSection(navSection);
    };
    Accordion.prototype._toggleSection = function (accSection) {
        var collapseElement = accSection.querySelector(QUERY_COLLAPSE);
        if (Dom.hasClass(accSection, CLASS_OPEN)) {
            Dom.removeClass(accSection, CLASS_OPEN);
            this._closeCollapseSection(collapseElement);
        }
        else {
            Dom.addClass(accSection, CLASS_OPEN);
            if (collapseElement) { // to ignore the case when there is no collapsible element (see sdx doku navigation, "all the basics") in a list of accordion
                this._openCollapseSection(collapseElement);
            }
        }
    };
    Accordion.prototype._openCollapseSection = function (el) {
        this._stopAnimations(el);
        el.style.display = "block";
        this.animation = anime.timeline()
            .add({
            targets: el,
            duration: ANIMATION_OPEN,
            height: el.scrollHeight + "px",
            easing: "cubicBezier(0.550, 0.085, 0.320, 1)",
            complete: function () {
                el.style.height = "auto";
                el.setAttribute("aria-expanded", "true");
                el.classList.add(CLASS_OPEN);
            }
        })
            .add({
            targets: el,
            duration: ANIMATION_VISIBLE,
            opacity: 1,
            easing: "linear",
            offset: ANIMATION_DELAY_OPEN
        });
    };
    Accordion.prototype._closeCollapseSection = function (el) {
        this._stopAnimations(el);
        this.animation = anime.timeline()
            .add({
            targets: el,
            duration: ANIMATION_OPEN,
            height: "0px",
            easing: "cubicBezier(0.550, 0.085, 0.320, 1)",
            complete: function () {
                el.style.removeProperty("display");
                el.style.removeProperty("opacity");
                el.style.removeProperty("height");
                el.setAttribute("aria-expanded", "false");
                el.classList.remove(CLASS_OPEN);
            }
        });
    };
    Accordion.prototype._stopAnimations = function (el) {
        if (this.lastAnimatedElement === el) {
            if (this.animation) {
                this.animation.pause();
            }
            anime.remove(el);
        }
        this.lastAnimatedElement = el;
    };
    /**
     * Removes all event handlers and clears references.
     */
    Accordion.prototype.destroy = function () {
        var e_2, _a;
        try {
            for (var _b = tslib_1.__values(this.element.querySelectorAll(QUERY_TOGGLE)), _c = _b.next(); !_c.done; _c = _b.next()) {
                var toggle = _c.value;
                toggle.removeEventListener("click", this._sectionClickHandler);
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_2) throw e_2.error; }
        }
        this._sectionClickHandler = null;
        this.element = null;
    };
    return Accordion;
}(DomElement));
export function init() {
    searchAndInitialize(".accordion", function (e) {
        new Accordion(e);
    });
}
export default Accordion;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4vc3JjL2FjY29yZGlvbi9BY2NvcmRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUM5QyxPQUFPLEtBQWdDLE1BQU0sU0FBUyxDQUFBO0FBQ3RELE9BQU8sVUFBVSxNQUFNLGVBQWUsQ0FBQTtBQUN0QyxPQUFPLEtBQUssR0FBRyxNQUFNLGlCQUFpQixDQUFBO0FBRXRDLElBQU0sWUFBWSxHQUFHLG9CQUFvQixDQUFBO0FBQ3pDLElBQU0sa0JBQWtCLEdBQUcsMEJBQTBCLENBQUE7QUFDckQsSUFBTSxjQUFjLEdBQUcsc0JBQXNCLENBQUE7QUFFN0MsSUFBTSxVQUFVLEdBQUcsaUJBQWlCLENBQUE7QUFDcEMsSUFBTSxVQUFVLEdBQUcsU0FBUyxDQUFBO0FBQzVCLElBQU0sZUFBZSxHQUFHLHNCQUFzQixDQUFBO0FBRTlDLElBQU0sWUFBWSxHQUFHLHNCQUFzQixDQUFBO0FBRTNDLElBQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQTtBQUMxQixJQUFNLG9CQUFvQixHQUFHLEVBQUUsQ0FBQTtBQUMvQixJQUFNLGlCQUFpQixHQUFHLEdBQUcsQ0FBQTtBQUU3Qjs7R0FFRztBQUNIO0lBQXdCLHFDQUFVO0lBTWhDOzs7T0FHRztJQUNILG1CQUFZLE9BQWdCO1FBQTVCLFlBQ0Usa0JBQU0sT0FBTyxDQUFDLFNBSWY7UUFGQyxLQUFJLENBQUMsb0JBQW9CLEdBQUcsS0FBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxLQUFJLENBQUMsQ0FBQTtRQUMvRCxLQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7O0lBQ3BCLENBQUM7SUFFRDs7O09BR0c7SUFDTywrQkFBVyxHQUFyQjs7UUFDRSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDLElBQUssT0FBQSxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFwQixDQUFvQixDQUFDLEVBQUU7WUFDdkUsSUFBSSxTQUFTLEdBQUcsSUFBSSxVQUFVLENBQW1CLE9BQU8sQ0FBQztpQkFDdEQsWUFBWSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUM7aUJBQzlCLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQTtZQUV4QixJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFBO1lBQzNCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFBO1NBQzFDOztZQUVELEtBQW1CLElBQUEsS0FBQSxpQkFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFBLGdCQUFBLDRCQUFFO2dCQUEzRCxJQUFJLE1BQU0sV0FBQTtnQkFDYixNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO2FBQzVEOzs7Ozs7Ozs7SUFDSCxDQUFDO0lBRVMsdUNBQW1CLEdBQTdCLFVBQThCLEtBQVk7UUFDeEMsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDekIsSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO1lBRTFELElBQUksS0FBSyxDQUFDLFVBQVUsS0FBSyxTQUFTLEVBQUU7Z0JBQ2xDLE9BQU07YUFDUDtTQUNGO1FBRUQsSUFBSSxVQUFVLEdBQUksS0FBSyxDQUFDLE1BQXNCLENBQUMsYUFBYyxDQUFBO1FBRTdELE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsSUFBSSxVQUFVLENBQUMsYUFBYSxFQUFFO1lBQ3hFLFVBQVUsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFBO1NBQ3RDO1FBRUQsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtRQUVoRSxJQUFJLFdBQVcsSUFBSSxXQUFXLEtBQUssVUFBVSxFQUFFO1lBQzdDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsZUFBZSxDQUFDLEVBQUM7Z0JBQy9DLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUE7YUFDakM7U0FDRjtRQUVELElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDakMsQ0FBQztJQUVTLGtDQUFjLEdBQXhCLFVBQXlCLFVBQW1CO1FBQzFDLElBQUksZUFBZSxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFpQixDQUFBO1FBRTlFLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLEVBQUU7WUFDeEMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUE7WUFDdkMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGVBQWUsQ0FBQyxDQUFBO1NBQzVDO2FBQU07WUFDTCxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQTtZQUNwQyxJQUFJLGVBQWUsRUFBRSxFQUFFLDZIQUE2SDtnQkFDbEosSUFBSSxDQUFDLG9CQUFvQixDQUFDLGVBQWUsQ0FBQyxDQUFBO2FBQzNDO1NBQ0Y7SUFDSCxDQUFDO0lBRVMsd0NBQW9CLEdBQTlCLFVBQStCLEVBQWU7UUFDNUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUV4QixFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7UUFFMUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsUUFBUSxFQUFFO2FBQzlCLEdBQUcsQ0FBQztZQUNILE9BQU8sRUFBRSxFQUFFO1lBQ1gsUUFBUSxFQUFFLGNBQWM7WUFDeEIsTUFBTSxFQUFFLEVBQUUsQ0FBQyxZQUFZLEdBQUcsSUFBSTtZQUM5QixNQUFNLEVBQUUscUNBQXFDO1lBQzdDLFFBQVEsRUFBRTtnQkFDUixFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUE7Z0JBQ3hCLEVBQUUsQ0FBQyxZQUFZLENBQUMsZUFBZSxFQUFFLE1BQU0sQ0FBQyxDQUFBO2dCQUN4QyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUM5QixDQUFDO1NBQ0YsQ0FBQzthQUNELEdBQUcsQ0FBQztZQUNILE9BQU8sRUFBRSxFQUFFO1lBQ1gsUUFBUSxFQUFFLGlCQUFpQjtZQUMzQixPQUFPLEVBQUUsQ0FBQztZQUNWLE1BQU0sRUFBRSxRQUFRO1lBQ2hCLE1BQU0sRUFBRSxvQkFBb0I7U0FDN0IsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQUVTLHlDQUFxQixHQUEvQixVQUFnQyxFQUFlO1FBQzdDLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUE7UUFFeEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsUUFBUSxFQUFFO2FBQzlCLEdBQUcsQ0FBQztZQUNILE9BQU8sRUFBRSxFQUFFO1lBQ1gsUUFBUSxFQUFFLGNBQWM7WUFDeEIsTUFBTSxFQUFFLEtBQUs7WUFDYixNQUFNLEVBQUUscUNBQXFDO1lBQzdDLFFBQVEsRUFBRTtnQkFDUixFQUFFLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQTtnQkFDbEMsRUFBRSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUE7Z0JBQ2xDLEVBQUUsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFBO2dCQUNqQyxFQUFFLENBQUMsWUFBWSxDQUFDLGVBQWUsRUFBRSxPQUFPLENBQUMsQ0FBQTtnQkFDekMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUE7WUFDakMsQ0FBQztTQUNGLENBQUMsQ0FBQTtJQUNOLENBQUM7SUFFUyxtQ0FBZSxHQUF6QixVQUEwQixFQUFlO1FBQ3ZDLElBQUksSUFBSSxDQUFDLG1CQUFtQixLQUFLLEVBQUUsRUFBRTtZQUNuQyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUE7YUFDdkI7WUFDRCxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1NBQ2pCO1FBQ0QsSUFBSSxDQUFDLG1CQUFtQixHQUFHLEVBQUUsQ0FBQTtJQUMvQixDQUFDO0lBRUQ7O09BRUc7SUFDSSwyQkFBTyxHQUFkOzs7WUFDRSxLQUFtQixJQUFBLEtBQUEsaUJBQUEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsQ0FBQSxnQkFBQSw0QkFBRTtnQkFBM0QsSUFBSSxNQUFNLFdBQUE7Z0JBQ2IsTUFBTSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQTthQUMvRDs7Ozs7Ozs7O1FBRUEsSUFBWSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQztRQUN6QyxJQUFZLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQTtJQUM5QixDQUFDO0lBQ0gsZ0JBQUM7QUFBRCxDQTlJQSxBQThJQyxDQTlJdUIsVUFBVSxHQThJakM7QUFFRCxNQUFNLFVBQVUsSUFBSTtJQUNsQixtQkFBbUIsQ0FBQyxZQUFZLEVBQUUsVUFBQyxDQUFDO1FBQ2xDLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2xCLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQUVELGVBQWUsU0FBUyxDQUFBIiwiZmlsZSI6Im1haW4vc3JjL2FjY29yZGlvbi9BY2NvcmRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzZWFyY2hBbmRJbml0aWFsaXplIH0gZnJvbSBcIi4uL1V0aWxzXCJcbmltcG9ydCBhbmltZSwgeyBBbmltZVRpbWVsaW5lSW5zdGFuY2UgfSBmcm9tIFwiYW5pbWVqc1wiXG5pbXBvcnQgRG9tRWxlbWVudCBmcm9tIFwiLi4vRG9tRWxlbWVudFwiXG5pbXBvcnQgKiBhcyBEb20gZnJvbSBcIi4uL0RvbUZ1bmN0aW9uc1wiXG5cbmNvbnN0IFFVRVJZX1RPR0dMRSA9IFwiLmFjY29yZGlvbl9fdG9nZ2xlXCJcbmNvbnN0IFFVRVJZX09QRU5fU0VDVElPTiA9IFwiLmFjY29yZGlvbl9faXRlbS5pcy1vcGVuXCJcbmNvbnN0IFFVRVJZX0NPTExBUFNFID0gXCIuYWNjb3JkaW9uX19jb2xsYXBzZVwiXG5cbmNvbnN0IENMQVNTX0lURU0gPSBcImFjY29yZGlvbl9faXRlbVwiXG5jb25zdCBDTEFTU19PUEVOID0gXCJpcy1vcGVuXCJcbmNvbnN0IENMQVNTX0tFRVBfT1BFTiA9IFwiYWNjb3JkaW9uX19rZWVwLW9wZW5cIlxuXG5jb25zdCBSRUdFWF9ISURERU4gPSAvYWNjb3JkaW9uLS1oaWRkZW4tLiovXG5cbmNvbnN0IEFOSU1BVElPTl9PUEVOID0gMzAwXG5jb25zdCBBTklNQVRJT05fREVMQVlfT1BFTiA9IDUwXG5jb25zdCBBTklNQVRJT05fVklTSUJMRSA9IDE1MFxuXG4vKipcbiAqIFRoZSBBY2NvcmRpb24gY29tcG9uZW50XG4gKi9cbmNsYXNzIEFjY29yZGlvbiBleHRlbmRzIERvbUVsZW1lbnQge1xuICBwcml2YXRlIF9zZWN0aW9uQ2xpY2tIYW5kbGVyOiAoZTogRXZlbnQpID0+IHZvaWRcbiAgcHJpdmF0ZSBfaGlkZGVuSW5kaWNhdG9yITogSFRNTElucHV0RWxlbWVudFxuICBwcml2YXRlIGFuaW1hdGlvbiE6IEFuaW1lVGltZWxpbmVJbnN0YW5jZVxuICBwcml2YXRlIGxhc3RBbmltYXRlZEVsZW1lbnQ/OiBIVE1MRWxlbWVudFxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuZCBpbml0aWFsaXplcyB0aGUgQWNjb3JkaW9uIGNvbXBvbmVudC5cbiAgICogQHBhcmFtIHtEb21FbGVtZW50fSAtIFRoZSByb290IGVsZW1lbnQgb2YgdGhlIEFjY29yZGlvbiBjb21wb25lbnQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihlbGVtZW50OiBFbGVtZW50KSB7XG4gICAgc3VwZXIoZWxlbWVudClcblxuICAgIHRoaXMuX3NlY3Rpb25DbGlja0hhbmRsZXIgPSB0aGlzLl9oYW5kbGVTZWN0aW9uQ2xpY2suYmluZCh0aGlzKVxuICAgIHRoaXMuX2luaXRpYWxpemUoKVxuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemVzIHRoZSBBY2NvcmRpb24gY29tcG9uZW50LlxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgcHJvdGVjdGVkIF9pbml0aWFsaXplKCkge1xuICAgIGlmICh0aGlzLmVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KFwiIFwiKS5zb21lKChjKSA9PiBSRUdFWF9ISURERU4udGVzdChjKSkpIHtcbiAgICAgIGxldCBpbmRpY2F0b3IgPSBuZXcgRG9tRWxlbWVudDxIVE1MSW5wdXRFbGVtZW50PihcImlucHV0XCIpXG4gICAgICAgIC5zZXRBdHRyaWJ1dGUoXCJ0eXBlXCIsIFwiaGlkZGVuXCIpXG4gICAgICAgIC5hZGRDbGFzcyhcImpzLWhpZGRlblwiKVxuXG4gICAgICB0aGlzLmFwcGVuZENoaWxkKGluZGljYXRvcilcbiAgICAgIHRoaXMuX2hpZGRlbkluZGljYXRvciA9IGluZGljYXRvci5lbGVtZW50XG4gICAgfVxuXG4gICAgZm9yIChsZXQgdG9nZ2xlIG9mIHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKFFVRVJZX1RPR0dMRSkpIHtcbiAgICAgIHRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgdGhpcy5fc2VjdGlvbkNsaWNrSGFuZGxlcilcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgX2hhbmRsZVNlY3Rpb25DbGljayhldmVudDogRXZlbnQpIHtcbiAgICBpZiAodGhpcy5faGlkZGVuSW5kaWNhdG9yKSB7XG4gICAgICBsZXQgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLl9oaWRkZW5JbmRpY2F0b3IpXG5cbiAgICAgIGlmIChzdHlsZS52aXNpYmlsaXR5ICE9PSBcInZpc2libGVcIikge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgbmF2U2VjdGlvbiA9IChldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQpLnBhcmVudEVsZW1lbnQhXG5cbiAgICB3aGlsZSAoIURvbS5oYXNDbGFzcyhuYXZTZWN0aW9uLCBDTEFTU19JVEVNKSAmJiBuYXZTZWN0aW9uLnBhcmVudEVsZW1lbnQpIHtcbiAgICAgIG5hdlNlY3Rpb24gPSBuYXZTZWN0aW9uLnBhcmVudEVsZW1lbnRcbiAgICB9XG5cbiAgICBsZXQgcHJldlNlY3Rpb24gPSB0aGlzLmVsZW1lbnQucXVlcnlTZWxlY3RvcihRVUVSWV9PUEVOX1NFQ1RJT04pXG5cbiAgICBpZiAocHJldlNlY3Rpb24gJiYgcHJldlNlY3Rpb24gIT09IG5hdlNlY3Rpb24pIHtcbiAgICAgIGlmICghRG9tLmhhc0NsYXNzKHRoaXMuZWxlbWVudCwgQ0xBU1NfS0VFUF9PUEVOKSl7XG4gICAgICAgIHRoaXMuX3RvZ2dsZVNlY3Rpb24ocHJldlNlY3Rpb24pXG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5fdG9nZ2xlU2VjdGlvbihuYXZTZWN0aW9uKVxuICB9XG5cbiAgcHJvdGVjdGVkIF90b2dnbGVTZWN0aW9uKGFjY1NlY3Rpb246IEVsZW1lbnQpIHtcbiAgICBsZXQgY29sbGFwc2VFbGVtZW50ID0gYWNjU2VjdGlvbi5xdWVyeVNlbGVjdG9yKFFVRVJZX0NPTExBUFNFKSEgYXMgSFRNTEVsZW1lbnRcblxuICAgIGlmIChEb20uaGFzQ2xhc3MoYWNjU2VjdGlvbiwgQ0xBU1NfT1BFTikpIHtcbiAgICAgIERvbS5yZW1vdmVDbGFzcyhhY2NTZWN0aW9uLCBDTEFTU19PUEVOKVxuICAgICAgdGhpcy5fY2xvc2VDb2xsYXBzZVNlY3Rpb24oY29sbGFwc2VFbGVtZW50KVxuICAgIH0gZWxzZSB7XG4gICAgICBEb20uYWRkQ2xhc3MoYWNjU2VjdGlvbiwgQ0xBU1NfT1BFTilcbiAgICAgIGlmIChjb2xsYXBzZUVsZW1lbnQpIHsgLy8gdG8gaWdub3JlIHRoZSBjYXNlIHdoZW4gdGhlcmUgaXMgbm8gY29sbGFwc2libGUgZWxlbWVudCAoc2VlIHNkeCBkb2t1IG5hdmlnYXRpb24sIFwiYWxsIHRoZSBiYXNpY3NcIikgaW4gYSBsaXN0IG9mIGFjY29yZGlvblxuICAgICAgICB0aGlzLl9vcGVuQ29sbGFwc2VTZWN0aW9uKGNvbGxhcHNlRWxlbWVudClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgX29wZW5Db2xsYXBzZVNlY3Rpb24oZWw6IEhUTUxFbGVtZW50KSB7XG4gICAgdGhpcy5fc3RvcEFuaW1hdGlvbnMoZWwpXG5cbiAgICBlbC5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiXG5cbiAgICB0aGlzLmFuaW1hdGlvbiA9IGFuaW1lLnRpbWVsaW5lKClcbiAgICAgIC5hZGQoe1xuICAgICAgICB0YXJnZXRzOiBlbCxcbiAgICAgICAgZHVyYXRpb246IEFOSU1BVElPTl9PUEVOLFxuICAgICAgICBoZWlnaHQ6IGVsLnNjcm9sbEhlaWdodCArIFwicHhcIixcbiAgICAgICAgZWFzaW5nOiBcImN1YmljQmV6aWVyKDAuNTUwLCAwLjA4NSwgMC4zMjAsIDEpXCIsXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gXCJhdXRvXCJcbiAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoXCJhcmlhLWV4cGFuZGVkXCIsIFwidHJ1ZVwiKVxuICAgICAgICAgIGVsLmNsYXNzTGlzdC5hZGQoQ0xBU1NfT1BFTilcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5hZGQoe1xuICAgICAgICB0YXJnZXRzOiBlbCxcbiAgICAgICAgZHVyYXRpb246IEFOSU1BVElPTl9WSVNJQkxFLFxuICAgICAgICBvcGFjaXR5OiAxLFxuICAgICAgICBlYXNpbmc6IFwibGluZWFyXCIsXG4gICAgICAgIG9mZnNldDogQU5JTUFUSU9OX0RFTEFZX09QRU5cbiAgICAgIH0pXG4gIH1cblxuICBwcm90ZWN0ZWQgX2Nsb3NlQ29sbGFwc2VTZWN0aW9uKGVsOiBIVE1MRWxlbWVudCkge1xuICAgIHRoaXMuX3N0b3BBbmltYXRpb25zKGVsKVxuXG4gICAgdGhpcy5hbmltYXRpb24gPSBhbmltZS50aW1lbGluZSgpXG4gICAgICAuYWRkKHtcbiAgICAgICAgdGFyZ2V0czogZWwsXG4gICAgICAgIGR1cmF0aW9uOiBBTklNQVRJT05fT1BFTixcbiAgICAgICAgaGVpZ2h0OiBcIjBweFwiLFxuICAgICAgICBlYXNpbmc6IFwiY3ViaWNCZXppZXIoMC41NTAsIDAuMDg1LCAwLjMyMCwgMSlcIixcbiAgICAgICAgY29tcGxldGU6ICgpID0+IHtcbiAgICAgICAgICBlbC5zdHlsZS5yZW1vdmVQcm9wZXJ0eShcImRpc3BsYXlcIilcbiAgICAgICAgICBlbC5zdHlsZS5yZW1vdmVQcm9wZXJ0eShcIm9wYWNpdHlcIilcbiAgICAgICAgICBlbC5zdHlsZS5yZW1vdmVQcm9wZXJ0eShcImhlaWdodFwiKVxuICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZShcImFyaWEtZXhwYW5kZWRcIiwgXCJmYWxzZVwiKVxuICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoQ0xBU1NfT1BFTilcbiAgICAgICAgfVxuICAgICAgfSlcbiAgfVxuXG4gIHByb3RlY3RlZCBfc3RvcEFuaW1hdGlvbnMoZWw6IEhUTUxFbGVtZW50KSB7XG4gICAgaWYgKHRoaXMubGFzdEFuaW1hdGVkRWxlbWVudCA9PT0gZWwpIHtcbiAgICAgIGlmICh0aGlzLmFuaW1hdGlvbikge1xuICAgICAgICB0aGlzLmFuaW1hdGlvbi5wYXVzZSgpXG4gICAgICB9XG4gICAgICBhbmltZS5yZW1vdmUoZWwpXG4gICAgfVxuICAgIHRoaXMubGFzdEFuaW1hdGVkRWxlbWVudCA9IGVsXG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBhbGwgZXZlbnQgaGFuZGxlcnMgYW5kIGNsZWFycyByZWZlcmVuY2VzLlxuICAgKi9cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgZm9yIChsZXQgdG9nZ2xlIG9mIHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKFFVRVJZX1RPR0dMRSkpIHtcbiAgICAgIHRvZ2dsZS5yZW1vdmVFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgdGhpcy5fc2VjdGlvbkNsaWNrSGFuZGxlcilcbiAgICB9XG5cbiAgICAodGhpcyBhcyBhbnkpLl9zZWN0aW9uQ2xpY2tIYW5kbGVyID0gbnVsbDtcbiAgICAodGhpcyBhcyBhbnkpLmVsZW1lbnQgPSBudWxsXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGluaXQoKSB7XG4gIHNlYXJjaEFuZEluaXRpYWxpemUoXCIuYWNjb3JkaW9uXCIsIChlKSA9PiB7XG4gICAgbmV3IEFjY29yZGlvbihlKVxuICB9KVxufVxuXG5leHBvcnQgZGVmYXVsdCBBY2NvcmRpb25cbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4vLi4ifQ==
