import * as tslib_1 from "tslib";
import DomElement from "../DomElement";
import { searchAndInitialize, remove } from "../Utils";
import { getAttributeReference } from "../DomFunctions";
import { tryGetData, createLegendItem, isColor, removeAllChildren } from "./ChartFunctions";
import anime from "animejs";
var QUERY_DETAIL_RIGHT = ".detail-right";
var QUERY_DETAIL_BOTTOM = ".detail-bottom";
var QUERY_PROGRESS = ".bar-chart__progress";
var CLASS_UNLIMITED = "bar-chart-horizontal--unlimited";
var CLASS_LIMITED = "bar-chart-horizontal--limited";
var CLASS_DETAIL_VALUE = "value";
var CLASS_DETAIL_UNIT = "unit";
var CLASS_INDICATOR = "indicator";
var CLASS_INDICATOR_WRAPPER = "indicator-wrapper";
var CLASS_TOOLTIP = "tooltip";
var CLASS_TOOLTIP_MULTILINE = "tooltip--multiline";
var ANIMATION_DURATION = 500;
/**
 * Bar Chart Horizontal Component.
 */
var BarChartHorizontal = /** @class */ (function (_super) {
    tslib_1.__extends(BarChartHorizontal, _super);
    /**
     * Creates and initializes the bar chart horizontal component.
     * @param {DomElement} - root element of the chart.
     */
    function BarChartHorizontal(element, data) {
        var _this = _super.call(this, element) || this;
        if (data) {
            _this._data = data;
        }
        _this._legendItems = [];
        _this._initialize();
        return _this;
    }
    BarChartHorizontal.prototype._initialize = function () {
        this._unit = this.getAttribute("data-unit") || "";
        this._maxValue = parseFloat(this.getAttribute("data-max"));
        this._precision = parseInt(this.getAttribute("data-precision"), 10) || 0;
        this._isUnlimited = this.hasClass(CLASS_UNLIMITED);
        this._isLimited = this.hasClass(CLASS_LIMITED);
        this._progessWrapper = this.element.querySelector(QUERY_PROGRESS);
        if (this._isLimited === true) {
            this._detailRight = this.element.querySelector(QUERY_DETAIL_BOTTOM);
        }
        else {
            this._detailRight = this.element.querySelector(QUERY_DETAIL_RIGHT);
        }
        if (this._isUnlimited === false && this._isLimited === false) {
            this._legend = getAttributeReference(this.element, "data-legend");
        }
        if (!this._data) {
            this._data = tryGetData(this.element);
        }
        this._render();
    };
    BarChartHorizontal.prototype._render = function () {
        var e_1, _a;
        var dataOne = this._data[0];
        var dataTwo = this._data[1];
        var tooltip = this._isLimited === false ? this._getTooltipContent(this._data) : undefined;
        var animatedValueElement;
        // Cleanup
        removeAllChildren(this._detailRight);
        removeAllChildren(this._progessWrapper);
        try {
            // Clear only own legend items
            for (var _b = tslib_1.__values(this._legendItems), _c = _b.next(); !_c.done; _c = _b.next()) {
                var item = _c.value;
                remove(item);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
        this._legendItems = [];
        if (dataOne) {
            if (this._isUnlimited === false || (this._isUnlimited === true && !dataTwo)) {
                var valElement = animatedValueElement = this._createValueElement(dataOne);
                this._detailRight.appendChild(valElement);
                if (this._isLimited === false) {
                    var separatorElement = new DomElement("div")
                        .addClass(CLASS_DETAIL_UNIT)
                        .element;
                    separatorElement.innerText = " " + this._unit;
                    this._detailRight.appendChild(separatorElement);
                }
            }
            // Add the indicator
            var indicator = this._addIndicator(dataOne, tooltip);
            this._animateIndicator(indicator, 0);
            // Animate the value if required
            if (animatedValueElement && this._isLimited === true) {
                this._animateValueElement(animatedValueElement, dataOne.value);
            }
            // Add the legend
            if (this._legend) {
                var legendItem = createLegendItem(dataOne);
                this._legend.appendChild(legendItem);
                this._legendItems.push(legendItem);
                this._animateLegend(legendItem, 0);
            }
        }
        if (dataTwo) {
            var valElement = this._createValueElement(dataTwo);
            var unitElement = new DomElement("div")
                .addClass(CLASS_DETAIL_UNIT)
                .element;
            unitElement.innerText = " " + this._unit;
            this._detailRight.appendChild(valElement);
            this._detailRight.appendChild(unitElement);
            // Add the indicator
            var indicator = this._addIndicator(dataTwo, tooltip);
            this._animateIndicator(indicator, ANIMATION_DURATION);
            // Add the legend
            if (this._legend) {
                var legendItem = createLegendItem(dataTwo);
                this._legend.appendChild(legendItem);
                this._legendItems.push(legendItem);
                this._animateLegend(legendItem, ANIMATION_DURATION);
            }
        }
        if (this._isLimited === true) {
            var valElement = this._createValueElement({ value: this._maxValue });
            var unitElement = new DomElement("div")
                .addClass(CLASS_DETAIL_UNIT)
                .element;
            unitElement.innerText = " " + this._unit;
            this._detailRight.appendChild(valElement);
            this._detailRight.appendChild(unitElement);
        }
    };
    BarChartHorizontal.prototype._animateValueElement = function (animatedValueElement, toValue) {
        var counter = { var: 0 };
        anime({
            targets: counter,
            var: toValue,
            duration: ANIMATION_DURATION,
            easing: "easeOutQuint",
            round: 1,
            update: function () {
                animatedValueElement.innerText = "" + counter.var;
            }
        });
    };
    BarChartHorizontal.prototype._animateIndicator = function (indicatorWrapper, animationOffset) {
        var indicator = indicatorWrapper.getElementsByClassName("indicator")[0];
        var indicatorWidth = indicator.scrollWidth;
        indicator.style.width = "0px";
        anime({
            targets: indicator,
            duration: ANIMATION_DURATION,
            width: indicatorWidth + "px",
            easing: "easeInOutQuint",
            delay: animationOffset,
            complete: function () {
                indicator.style.width = "";
            }
        });
    };
    BarChartHorizontal.prototype._animateLegend = function (legendItem, animationOffset) {
        legendItem.style.opacity = "0";
        anime({
            targets: legendItem,
            duration: ANIMATION_DURATION,
            opacity: 1,
            easing: "easeInOutQuint",
            delay: animationOffset,
            complete: function () {
                legendItem.style.opacity = null;
            }
        });
    };
    BarChartHorizontal.prototype._createValueElement = function (data) {
        var unlimitedPrefix = "";
        if (this._isUnlimited === true) {
            unlimitedPrefix = "+";
        }
        var value = parseFloat(data.value);
        if (value <= 0) {
            if (this._precision === 0) {
                value = "0";
            }
            else {
                value = ".";
                for (var i = 0; i < this._precision; i++) {
                    value += "0";
                }
            }
        }
        else {
            value = value.toFixed(this._precision);
        }
        var valueElement = new DomElement("div")
            .addClass(CLASS_DETAIL_VALUE)
            .element;
        valueElement.innerText = "" + unlimitedPrefix + value;
        return valueElement;
    };
    BarChartHorizontal.prototype._addIndicator = function (data, tooltip) {
        var width = ((100.0 / this._maxValue) * data.value);
        var indicator = new DomElement("div")
            .addClass(CLASS_INDICATOR);
        if (isColor(data.color) === true) {
            indicator.setAttribute("style", "background-color: " + data.color + ";");
        }
        else {
            indicator.addClass(data.color);
        }
        var indicatorWrapper = new DomElement("div")
            .addClass(CLASS_INDICATOR_WRAPPER)
            .setAttribute("style", "width: " + width + "%")
            .appendChild(indicator)
            .setAttribute("onclick", "void(0)");
        if (tooltip && tooltip !== "") {
            indicatorWrapper
                .addClass(CLASS_TOOLTIP)
                .addClass(CLASS_TOOLTIP_MULTILINE)
                .setAttribute("aria-label", tooltip);
        }
        this._progessWrapper.appendChild(indicatorWrapper.element);
        return indicatorWrapper.element;
    };
    BarChartHorizontal.prototype._getTooltipContent = function (dataList) {
        var e_2, _a;
        var tooltip = "";
        try {
            for (var dataList_1 = tslib_1.__values(dataList), dataList_1_1 = dataList_1.next(); !dataList_1_1.done; dataList_1_1 = dataList_1.next()) {
                var data = dataList_1_1.value;
                tooltip += data.title + ": " + data.value + " " + this._unit + "\n";
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (dataList_1_1 && !dataList_1_1.done && (_a = dataList_1.return)) _a.call(dataList_1);
            }
            finally { if (e_2) throw e_2.error; }
        }
        return tooltip.trim();
    };
    /**
     * Updates the bar chart with the specified data definitions.
     * @param {Array} - bar chart data definitions.
     */
    BarChartHorizontal.prototype.update = function (data) {
        if (data) {
            this._data = data;
        }
        this._render();
    };
    /**
     * Removes all event handlers and clears references.
     */
    BarChartHorizontal.prototype.destroy = function () {
        var e_3, _a;
        this._data = undefined;
        removeAllChildren(this._detailRight);
        removeAllChildren(this._progessWrapper);
        this._detailRight = undefined;
        this._progessWrapper = undefined;
        try {
            for (var _b = tslib_1.__values(this._legendItems), _c = _b.next(); !_c.done; _c = _b.next()) {
                var item = _c.value;
                remove(item);
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_3) throw e_3.error; }
        }
        this._legendItems = undefined;
        this._legend = undefined;
    };
    /**
     * @deprecated use destroy() instead.
     * @todo remove in version 2.0.0
     */
    BarChartHorizontal.prototype.destory = function () {
        this.destroy();
    };
    return BarChartHorizontal;
}(DomElement));
export function init() {
    searchAndInitialize(".bar-chart-horizontal", function (e) {
        new BarChartHorizontal(e);
    });
}
export default BarChartHorizontal;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4vc3JjL2NoYXJ0cy9CYXJDaGFydEhvcml6b250YWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sVUFBVSxNQUFNLGVBQWUsQ0FBQTtBQUN0QyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQ3RELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGlCQUFpQixDQUFBO0FBQ3ZELE9BQU8sRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsT0FBTyxFQUFFLGlCQUFpQixFQUF3QixNQUFNLGtCQUFrQixDQUFBO0FBRWpILE9BQU8sS0FBSyxNQUFNLFNBQVMsQ0FBQTtBQUUzQixJQUFNLGtCQUFrQixHQUFHLGVBQWUsQ0FBQTtBQUMxQyxJQUFNLG1CQUFtQixHQUFHLGdCQUFnQixDQUFBO0FBQzVDLElBQU0sY0FBYyxHQUFHLHNCQUFzQixDQUFBO0FBRTdDLElBQU0sZUFBZSxHQUFHLGlDQUFpQyxDQUFBO0FBQ3pELElBQU0sYUFBYSxHQUFHLCtCQUErQixDQUFBO0FBRXJELElBQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFBO0FBQ2xDLElBQU0saUJBQWlCLEdBQUcsTUFBTSxDQUFBO0FBRWhDLElBQU0sZUFBZSxHQUFHLFdBQVcsQ0FBQTtBQUNuQyxJQUFNLHVCQUF1QixHQUFHLG1CQUFtQixDQUFBO0FBRW5ELElBQU0sYUFBYSxHQUFHLFNBQVMsQ0FBQTtBQUMvQixJQUFNLHVCQUF1QixHQUFHLG9CQUFvQixDQUFBO0FBRXBELElBQU0sa0JBQWtCLEdBQUcsR0FBRyxDQUFBO0FBRTlCOztHQUVHO0FBQ0g7SUFBaUMsOENBQXVCO0lBZ0J0RDs7O09BR0c7SUFDSCw0QkFBWSxPQUFvQixFQUFFLElBQWdCO1FBQWxELFlBQ0Usa0JBQU0sT0FBTyxDQUFDLFNBU2Y7UUFQQyxJQUFJLElBQUksRUFBRTtZQUNSLEtBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFBO1NBQ2xCO1FBRUQsS0FBSSxD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QUFDLE9BQU8sRUFBRSxDQUFBO0lBQ2hCLENBQUM7SUFDSCx5QkFBQztBQUFELENBOVNBLEFBOFNDLENBOVNnQyxVQUFVLEdBOFMxQztBQUVELE1BQU0sVUFBVSxJQUFJO0lBQ2xCLG1CQUFtQixDQUFjLHVCQUF1QixFQUFFLFVBQUMsQ0FBQztRQUMxRCxJQUFJLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzNCLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQUVELGVBQWUsa0JBQWtCLENBQUEiLCJmaWxlIjoibWFpbi9zcmMvY2hhcnRzL0JhckNoYXJ0SG9yaXpvbnRhbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBEb21FbGVtZW50IGZyb20gXCIuLi9Eb21FbGVtZW50XCJcbmltcG9ydCB7IHNlYXJjaEFuZEluaXRpYWxpemUsIHJlbW92ZSB9IGZyb20gXCIuLi9VdGlsc1wiXG5pbXBvcnQgeyBnZXRBdHRyaWJ1dGVSZWZlcmVuY2UgfSBmcm9tIFwiLi4vRG9tRnVuY3Rpb25zXCJcbmltcG9ydCB7IHRyeUdldERhdGEsIGNyZWF0ZUxlZ2VuZEl0ZW0sIGlzQ29sb3IsIHJlbW92ZUFsbENoaWxkcmVuLCBDaGFydERhdGEsIENoYXJ0QXhpcyB9IGZyb20gXCIuL0NoYXJ0RnVuY3Rpb25zXCJcblxuaW1wb3J0IGFuaW1lIGZyb20gXCJhbmltZWpzXCJcblxuY29uc3QgUVVFUllfREVUQUlMX1JJR0hUID0gXCIuZGV0YWlsLXJpZ2h0XCJcbmNvbnN0IFFVRVJZX0RFVEFJTF9CT1RUT00gPSBcIi5kZXRhaWwtYm90dG9tXCJcbmNvbnN0IFFVRVJZX1BST0dSRVNTID0gXCIuYmFyLWNoYXJ0X19wcm9ncmVzc1wiXG5cbmNvbnN0IENMQVNTX1VOTElNSVRFRCA9IFwiYmFyLWNoYXJ0LWhvcml6b250YWwtLXVubGltaXRlZFwiXG5jb25zdCBDTEFTU19MSU1JVEVEID0gXCJiYXItY2hhcnQtaG9yaXpvbnRhbC0tbGltaXRlZFwiXG5cbmNvbnN0IENMQVNTX0RFVEFJTF9WQUxVRSA9IFwidmFsdWVcIlxuY29uc3QgQ0xBU1NfREVUQUlMX1VOSVQgPSBcInVuaXRcIlxuXG5jb25zdCBDTEFTU19JTkRJQ0FUT1IgPSBcImluZGljYXRvclwiXG5jb25zdCBDTEFTU19JTkRJQ0FUT1JfV1JBUFBFUiA9IFwiaW5kaWNhdG9yLXdyYXBwZXJcIlxuXG5jb25zdCBDTEFTU19UT09MVElQID0gXCJ0b29sdGlwXCJcbmNvbnN0IENMQVNTX1RPT0xUSVBfTVVMVElMSU5FID0gXCJ0b29sdGlwLS1tdWx0aWxpbmVcIlxuXG5jb25zdCBBTklNQVRJT05fRFVSQVRJT04gPSA1MDBcblxuLyoqXG4gKiBCYXIgQ2hhcnQgSG9yaXpvbnRhbCBDb21wb25lbnQuXG4gKi9cbmNsYXNzIEJhckNoYXJ0SG9yaXpvbnRhbCBleHRlbmRzIERvbUVsZW1lbnQ8SFRNTEVsZW1lbnQ+IHtcbiAgcHJpdmF0ZSBfZGF0YSE6IENoYXJ0RGF0YVxuXG4gIHByaXZhdGUgX2xlZ2VuZEl0ZW1zOiBIVE1MRWxlbWVudFtdXG4gIHByaXZhdGUgX3Byb2dlc3NXcmFwcGVyITogSFRNTEVsZW1lbnRcblxuICBwcml2YXRlIF91bml0ITogc3RyaW5nXG4gIHByaXZhdGUgX21heFZhbHVlITogbnVtYmVyXG4gIHByaXZhdGUgX3ByZWNpc2lvbiE6IG51bWJlclxuXG4gIHByaXZhdGUgX2lzVW5saW1pdGVkITogYm9vbGVhblxuICBwcml2YXRlIF9pc0xpbWl0ZWQhOiBib29sZWFuXG5cbiAgcHJpdmF0ZSBfZGV0YWlsUmlnaHQhOiBIVE1MRWxlbWVudFxuICBwcml2YXRlIF9sZWdlbmQhOiBIVE1MRWxlbWVudFxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuZCBpbml0aWFsaXplcyB0aGUgYmFyIGNoYXJ0IGhvcml6b250YWwgY29tcG9uZW50LlxuICAgKiBAcGFyYW0ge0RvbUVsZW1lbnR9IC0gcm9vdCBlbGVtZW50IG9mIHRoZSBjaGFydC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBkYXRhPzogQ2hhcnREYXRhKSB7XG4gICAgc3VwZXIoZWxlbWVudClcblxuICAgIGlmIChkYXRhKSB7XG4gICAgICB0aGlzLl9kYXRhID0gZGF0YVxuICAgIH1cblxuICAgIHRoaXMuX2xlZ2VuZEl0ZW1zID0gW11cblxuICAgIHRoaXMuX2luaXRpYWxpemUoKVxuICB9XG5cbiAgcHJvdGVjdGVkIF9pbml0aWFsaXplKCkge1xuICAgIHRoaXMuX3VuaXQgPSB0aGlzLmdldEF0dHJpYnV0ZShcImRhdGEtdW5pdFwiKSB8fCBcIlwiXG4gICAgdGhpcy5fbWF4VmFsdWUgPSBwYXJzZUZsb2F0KHRoaXMuZ2V0QXR0cmlidXRlKFwiZGF0YS1tYXhcIikhKVxuICAgIHRoaXMuX3ByZWNpc2lvbiA9IHBhcnNlSW50KHRoaXMuZ2V0QXR0cmlidXRlKFwiZGF0YS1wcmVjaXNpb25cIikhLCAxMCkgfHwgMFxuXG4gICAgdGhpcy5faXNVbmxpbWl0ZWQgPSB0aGlzLmhhc0NsYXNzKENMQVNTX1VOTElNSVRFRClcbiAgICB0aGlzLl9pc0xpbWl0ZWQgPSB0aGlzLmhhc0NsYXNzKENMQVNTX0xJTUlURUQpXG5cbiAgICB0aGlzLl9wcm9nZXNzV3JhcHBlciA9IHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yKFFVRVJZX1BST0dSRVNTKSEgYXMgSFRNTEVsZW1lbnRcblxuICAgIGlmICh0aGlzLl9pc0xpbWl0ZWQgPT09IHRydWUpIHtcbiAgICAgIHRoaXMuX2RldGFpbFJpZ2h0ID0gdGhpcy5lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoUVVFUllfREVUQUlMX0JPVFRPTSkhIGFzIEhUTUxFbGVtZW50XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2RldGFpbFJpZ2h0ID0gdGhpcy5lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoUVVFUllfREVUQUlMX1JJR0hUKSEgYXMgSFRNTEVsZW1lbnRcbiAgICB9XG5cbiAgICBpZiAodGhpcy5faXNVbmxpbWl0ZWQgPT09IGZhbHNlICYmIHRoaXMuX2lzTGltaXRlZCA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMuX2xlZ2VuZCA9IGdldEF0dHJpYnV0ZVJlZmVyZW5jZSh0aGlzLmVsZW1lbnQsIFwiZGF0YS1sZWdlbmRcIikhXG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLl9kYXRhKSB7XG4gICAgICB0aGlzLl9kYXRhID0gdHJ5R2V0RGF0YSh0aGlzLmVsZW1lbnQpXG4gICAgfVxuXG4gICAgdGhpcy5fcmVuZGVyKClcbiAgfVxuXG4gIHByb3RlY3RlZCBfcmVuZGVyKCkge1xuICAgIGxldCBkYXRhT25lID0gdGhpcy5fZGF0YVswXVxuICAgIGxldCBkYXRhVHdvID0gdGhpcy5fZGF0YVsxXVxuXG4gICAgbGV0IHRvb2x0aXAgPSB0aGlzLl9pc0xpbWl0ZWQgPT09IGZhbHNlID8gdGhpcy5fZ2V0VG9vbHRpcENvbnRlbnQodGhpcy5fZGF0YSkgOiB1bmRlZmluZWRcblxuICAgIGxldCBhbmltYXRlZFZhbHVlRWxlbWVudDogRWxlbWVudCB8IHVuZGVmaW5lZFxuXG4gICAgLy8gQ2xlYW51cFxuICAgIHJlbW92ZUFsbENoaWxkcmVuKHRoaXMuX2RldGFpbFJpZ2h0KVxuICAgIHJlbW92ZUFsbENoaWxkcmVuKHRoaXMuX3Byb2dlc3NXcmFwcGVyKVxuXG4gICAgLy8gQ2xlYXIgb25seSBvd24gbGVnZW5kIGl0ZW1zXG4gICAgZm9yIChsZXQgaXRlbSBvZiB0aGlzLl9sZWdlbmRJdGVtcykge1xuICAgICAgcmVtb3ZlKGl0ZW0pXG4gICAgfVxuICAgIHRoaXMuX2xlZ2VuZEl0ZW1zID0gW11cblxuICAgIGlmIChkYXRhT25lKSB7XG4gICAgICBpZiAodGhpcy5faXNVbmxpbWl0ZWQgPT09IGZhbHNlIHx8ICh0aGlzLl9pc1VubGltaXRlZCA9PT0gdHJ1ZSAmJiAhZGF0YVR3bykpIHtcblxuICAgICAgICBsZXQgdmFsRWxlbWVudCA9IGFuaW1hdGVkVmFsdWVFbGVtZW50ID0gdGhpcy5fY3JlYXRlVmFsdWVFbGVtZW50KGRhdGFPbmUpXG4gICAgICAgIHRoaXMuX2RldGFpbFJpZ2h0LmFwcGVuZENoaWxkKHZhbEVsZW1lbnQpXG5cbiAgICAgICAgaWYgKHRoaXMuX2lzTGltaXRlZCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICBjb25zdCBzZXBhcmF0b3JFbGVtZW50ID0gbmV3IERvbUVsZW1lbnQoXCJkaXZcIilcbiAgICAgICAgICAgIC5hZGRDbGFzcyhDTEFTU19ERVRBSUxfVU5JVClcbiAgICAgICAgICAgIC5lbGVtZW50IGFzIEhUTUxFbGVtZW50XG4gICAgICAgICAgc2VwYXJhdG9yRWxlbWVudC5pbm5lclRleHQgPSBgICR7dGhpcy5fdW5pdH1gXG5cbiAgICAgICAgICB0aGlzLl9kZXRhaWxSaWdodC5hcHBlbmRDaGlsZChzZXBhcmF0b3JFbGVtZW50KVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIEFkZCB0aGUgaW5kaWNhdG9yXG4gICAgICBsZXQgaW5kaWNhdG9yID0gdGhpcy5fYWRkSW5kaWNhdG9yKGRhdGFPbmUsIHRvb2x0aXApXG4gICAgICB0aGlzLl9hbmltYXRlSW5kaWNhdG9yKGluZGljYXRvciwgMClcblxuICAgICAgLy8gQW5pbWF0ZSB0aGUgdmFsdWUgaWYgcmVxdWlyZWRcbiAgICAgIGlmIChhbmltYXRlZFZhbHVlRWxlbWVudCAmJiB0aGlzLl9pc0xpbWl0ZWQgPT09IHRydWUpIHtcbiAgICAgICAgdGhpcy5fYW5pbWF0ZVZhbHVlRWxlbWVudChhbmltYXRlZFZhbHVlRWxlbWVudCBhcyBIVE1MRWxlbWVudCwgZGF0YU9uZS52YWx1ZSlcbiAgICAgIH1cblxuICAgICAgLy8gQWRkIHRoZSBsZWdlbmRcbiAgICAgIGlmICh0aGlzLl9sZWdlbmQpIHtcbiAgICAgICAgY29uc3QgbGVnZW5kSXRlbSA9IGNyZWF0ZUxlZ2VuZEl0ZW0oZGF0YU9uZSlcbiAgICAgICAgdGhpcy5fbGVnZW5kLmFwcGVuZENoaWxkKGxlZ2VuZEl0ZW0pXG4gICAgICAgIHRoaXMuX2xlZ2VuZEl0ZW1zLnB1c2gobGVnZW5kSXRlbSlcblxuICAgICAgICB0aGlzLl9hbmltYXRlTGVnZW5kKGxlZ2VuZEl0ZW0sIDApXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGRhdGFUd28pIHtcbiAgICAgIGxldCB2YWxFbGVtZW50ID0gdGhpcy5fY3JlYXRlVmFsdWVFbGVtZW50KGRhdGFUd28pXG5cbiAgICAgIGxldCB1bml0RWxlbWVudCA9IG5ldyBEb21FbGVtZW50KFwiZGl2XCIpXG4gICAgICAgIC5hZGRDbGFzcyhDTEFTU19ERVRBSUxfVU5JVClcbiAgICAgICAgLmVsZW1lbnQgYXMgSFRNTEVsZW1lbnRcbiAgICAgIHVuaXRFbGVtZW50LmlubmVyVGV4dCA9IGAgJHt0aGlzLl91bml0fWBcblxuICAgICAgdGhpcy5fZGV0YWlsUmlnaHQuYXBwZW5kQ2hpbGQodmFsRWxlbWVudClcbiAgICAgIHRoaXMuX2RldGFpbFJpZ2h0LmFwcGVuZENoaWxkKHVuaXRFbGVtZW50KVxuXG4gICAgICAvLyBBZGQgdGhlIGluZGljYXRvclxuICAgICAgbGV0IGluZGljYXRvciA9IHRoaXMuX2FkZEluZGljYXRvcihkYXRhVHdvLCB0b29sdGlwKVxuICAgICAgdGhpcy5fYW5pbWF0ZUluZGljYXRvcihpbmRpY2F0b3IsIEFOSU1BVElPTl9EVVJBVElPTilcblxuICAgICAgLy8gQWRkIHRoZSBsZWdlbmRcbiAgICAgIGlmICh0aGlzLl9sZWdlbmQpIHtcbiAgICAgICAgY29uc3QgbGVnZW5kSXRlbSA9IGNyZWF0ZUxlZ2VuZEl0ZW0oZGF0YVR3bylcbiAgICAgICAgdGhpcy5fbGVnZW5kLmFwcGVuZENoaWxkKGxlZ2VuZEl0ZW0pXG4gICAgICAgIHRoaXMuX2xlZ2VuZEl0ZW1zLnB1c2gobGVnZW5kSXRlbSlcblxuICAgICAgICB0aGlzLl9hbmltYXRlTGVnZW5kKGxlZ2VuZEl0ZW0sIEFOSU1BVElPTl9EVVJBVElPTilcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5faXNMaW1pdGVkID09PSB0cnVlKSB7XG4gICAgICBsZXQgdmFsRWxlbWVudCA9IHRoaXMuX2NyZWF0ZVZhbHVlRWxlbWVudCh7IHZhbHVlOiB0aGlzLl9tYXhWYWx1ZSB9KVxuXG4gICAgICBsZXQgdW5pdEVsZW1lbnQgPSBuZXcgRG9tRWxlbWVudChcImRpdlwiKVxuICAgICAgICAuYWRkQ2xhc3MoQ0xBU1NfREVUQUlMX1VOSVQpXG4gICAgICAgIC5lbGVtZW50IGFzIEhUTUxFbGVtZW50XG4gICAgICB1bml0RWxlbWVudC5pbm5lclRleHQgPSBgICR7dGhpcy5fdW5pdH1gXG5cbiAgICAgIHRoaXMuX2RldGFpbFJpZ2h0LmFwcGVuZENoaWxkKHZhbEVsZW1lbnQpXG4gICAgICB0aGlzLl9kZXRhaWxSaWdodC5hcHBlbmRDaGlsZCh1bml0RWxlbWVudClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9hbmltYXRlVmFsdWVFbGVtZW50KGFuaW1hdGVkVmFsdWVFbGVtZW50OiBIVE1MRWxlbWVudCwgdG9WYWx1ZTogbnVtYmVyKSB7XG4gICAgbGV0IGNvdW50ZXIgPSB7IHZhcjogMCB9XG4gICAgYW5pbWUoe1xuICAgICAgdGFyZ2V0czogY291bnRlcixcbiAgICAgIHZhcjogdG9WYWx1ZSxcbiAgICAgIGR1cmF0aW9uOiBBTklNQVRJT05fRFVSQVRJT04sXG4gICAgICBlYXNpbmc6IFwiZWFzZU91dFF1aW50XCIsXG4gICAgICByb3VuZDogMSxcbiAgICAgIHVwZGF0ZTogKCkgPT4ge1xuICAgICAgICBhbmltYXRlZFZhbHVlRWxlbWVudCEuaW5uZXJUZXh0ID0gYCR7Y291bnRlci52YXJ9YFxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIF9hbmltYXRlSW5kaWNhdG9yKGluZGljYXRvcldyYXBwZXI6IEhUTUxFbGVtZW50LCBhbmltYXRpb25PZmZzZXQ6IG51bWJlcikge1xuICAgIGNvbnN0IGluZGljYXRvciA9IGluZGljYXRvcldyYXBwZXIuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcImluZGljYXRvclwiKVswXSBhcyBIVE1MRWxlbWVudFxuICAgIGNvbnN0IGluZGljYXRvcldpZHRoID0gaW5kaWNhdG9yLnNjcm9sbFdpZHRoXG4gICAgaW5kaWNhdG9yLnN0eWxlLndpZHRoID0gXCIwcHhcIlxuXG4gICAgYW5pbWUoe1xuICAgICAgdGFyZ2V0czogaW5kaWNhdG9yLFxuICAgICAgZHVyYXRpb246IEFOSU1BVElPTl9EVVJBVElPTixcbiAgICAgIHdpZHRoOiBpbmRpY2F0b3JXaWR0aCArIFwicHhcIixcbiAgICAgIGVhc2luZzogXCJlYXNlSW5PdXRRdWludFwiLFxuICAgICAgZGVsYXk6IGFuaW1hdGlvbk9mZnNldCxcbiAgICAgIGNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICAgIGluZGljYXRvci5zdHlsZS53aWR0aCA9IFwiXCJcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBfYW5pbWF0ZUxlZ2VuZChsZWdlbmRJdGVtOiBIVE1MRWxlbWVudCwgYW5pbWF0aW9uT2Zmc2V0OiBudW1iZXIpIHtcbiAgICBsZWdlbmRJdGVtLnN0eWxlLm9wYWNpdHkgPSBcIjBcIlxuICAgIGFuaW1lKHtcbiAgICAgIHRhcmdldHM6IGxlZ2VuZEl0ZW0sXG4gICAgICBkdXJhdGlvbjogQU5JTUFUSU9OX0RVUkFUSU9OLFxuICAgICAgb3BhY2l0eTogMSxcbiAgICAgIGVhc2luZzogXCJlYXNlSW5PdXRRdWludFwiLFxuICAgICAgZGVsYXk6IGFuaW1hdGlvbk9mZnNldCxcbiAgICAgIGNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICAgIGxlZ2VuZEl0ZW0uc3R5bGUub3BhY2l0eSA9IG51bGxcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHJvdGVjdGVkIF9jcmVhdGVWYWx1ZUVsZW1lbnQoZGF0YTogeyB2YWx1ZTogbnVtYmVyIHwgc3RyaW5nIH0pIHtcbiAgICBsZXQgdW5saW1pdGVkUHJlZml4ID0gXCJcIlxuXG4gICAgaWYgKHRoaXMuX2lzVW5saW1pdGVkID09PSB0cnVlKSB7XG4gICAgICB1bmxpbWl0ZWRQcmVmaXggPSBcIitcIlxuICAgIH1cblxuICAgIGxldCB2YWx1ZTogc3RyaW5nIHwgbnVtYmVyID0gcGFyc2VGbG9hdCgoZGF0YS52YWx1ZSBhcyBzdHJpbmcpKVxuXG4gICAgaWYgKHZhbHVlIDw9IDApIHtcbiAgICAgIGlmICh0aGlzLl9wcmVjaXNpb24gPT09IDApIHtcbiAgICAgICAgdmFsdWUgPSBcIjBcIlxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFsdWUgPSBcIi5cIlxuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcHJlY2lzaW9uOyBpKyspIHtcbiAgICAgICAgICB2YWx1ZSArPSBcIjBcIlxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhbHVlID0gdmFsdWUudG9GaXhlZCh0aGlzLl9wcmVjaXNpb24pXG4gICAgfVxuXG4gICAgY29uc3QgdmFsdWVFbGVtZW50ID0gbmV3IERvbUVsZW1lbnQoXCJkaXZcIilcbiAgICAgIC5hZGRDbGFzcyhDTEFTU19ERVRBSUxfVkFMVUUpXG4gICAgICAuZWxlbWVudCBhcyBIVE1MRWxlbWVudFxuICAgIHZhbHVlRWxlbWVudC5pbm5lclRleHQgPSBgJHt1bmxpbWl0ZWRQcmVmaXh9JHt2YWx1ZX1gXG4gICAgcmV0dXJuIHZhbHVlRWxlbWVudFxuICB9XG5cbiAgcHJvdGVjdGVkIF9hZGRJbmRpY2F0b3IoZGF0YTogQ2hhcnRBeGlzLCB0b29sdGlwPzogc3RyaW5nKSB7XG4gICAgbGV0IHdpZHRoID0gKCgxMDAuMCAvIHRoaXMuX21heFZhbHVlKSAqIGRhdGEudmFsdWUpXG5cbiAgICBsZXQgaW5kaWNhdG9yID0gbmV3IERvbUVsZW1lbnQoXCJkaXZcIilcbiAgICAgIC5hZGRDbGFzcyhDTEFTU19JTkRJQ0FUT1IpXG5cbiAgICBpZiAoaXNDb2xvcihkYXRhLmNvbG9yKSA9PT0gdHJ1ZSkge1xuICAgICAgaW5kaWNhdG9yLnNldEF0dHJpYnV0ZShcInN0eWxlXCIsIGBiYWNrZ3JvdW5kLWNvbG9yOiAke2RhdGEuY29sb3J9O2ApXG4gICAgfSBlbHNlIHtcbiAgICAgIGluZGljYXRvci5hZGRDbGFzcyhkYXRhLmNvbG9yKVxuICAgIH1cblxuICAgIGxldCBpbmRpY2F0b3JXcmFwcGVyID0gbmV3IERvbUVsZW1lbnQoXCJkaXZcIilcbiAgICAgIC5hZGRDbGFzcyhDTEFTU19JTkRJQ0FUT1JfV1JBUFBFUilcbiAgICAgIC5zZXRBdHRyaWJ1dGUoXCJzdHlsZVwiLCBgd2lkdGg6ICR7d2lkdGh9JWApXG4gICAgICAuYXBwZW5kQ2hpbGQoaW5kaWNhdG9yKVxuICAgICAgLnNldEF0dHJpYnV0ZShcIm9uY2xpY2tcIiwgXCJ2b2lkKDApXCIpXG5cbiAgICBpZiAodG9vbHRpcCAmJiB0b29sdGlwICE9PSBcIlwiKSB7XG4gICAgICBpbmRpY2F0b3JXcmFwcGVyXG4gICAgICAgIC5hZGRDbGFzcyhDTEFTU19UT09MVElQKVxuICAgICAgICAuYWRkQ2xhc3MoQ0xBU1NfVE9PTFRJUF9NVUxUSUxJTkUpXG4gICAgICAgIC5zZXRBdHRyaWJ1dGUoXCJhcmlhLWxhYmVsXCIsIHRvb2x0aXApXG4gICAgfVxuXG4gICAgdGhpcy5fcHJvZ2Vzc1dyYXBwZXIuYXBwZW5kQ2hpbGQoaW5kaWNhdG9yV3JhcHBlci5lbGVtZW50KVxuICAgIHJldHVybiBpbmRpY2F0b3JXcmFwcGVyLmVsZW1lbnQgYXMgSFRNTEVsZW1lbnRcbiAgfVxuXG4gIHByb3RlY3RlZCBfZ2V0VG9vbHRpcENvbnRlbnQoZGF0YUxpc3Q6IENoYXJ0RGF0YSkge1xuICAgIGxldCB0b29sdGlwID0gXCJcIlxuICAgIGZvciAobGV0IGRhdGEgb2YgZGF0YUxpc3QpIHtcbiAgICAgIHRvb2x0aXAgKz0gYCR7ZGF0YS50aXRsZX06ICR7ZGF0YS52YWx1ZX0gJHt0aGlzLl91bml0fVxcbmBcbiAgICB9XG5cbiAgICByZXR1cm4gdG9vbHRpcC50cmltKClcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSBiYXIgY2hhcnQgd2l0aCB0aGUgc3BlY2lmaWVkIGRhdGEgZGVmaW5pdGlvbnMuXG4gICAqIEBwYXJhbSB7QXJyYXl9IC0gYmFyIGNoYXJ0IGRhdGEgZGVmaW5pdGlvbnMuXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlKGRhdGE6IENoYXJ0RGF0YSkge1xuICAgIGlmIChkYXRhKSB7XG4gICAgICB0aGlzLl9kYXRhID0gZGF0YVxuICAgIH1cblxuICAgIHRoaXMuX3JlbmRlcigpXG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBhbGwgZXZlbnQgaGFuZGxlcnMgYW5kIGNsZWFycyByZWZlcmVuY2VzLlxuICAgKi9cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgKHRoaXMgYXMgYW55KS5fZGF0YSA9IHVuZGVmaW5lZFxuXG4gICAgcmVtb3ZlQWxsQ2hpbGRyZW4odGhpcy5fZGV0YWlsUmlnaHQpXG4gICAgcmVtb3ZlQWxsQ2hpbGRyZW4odGhpcy5fcHJvZ2Vzc1dyYXBwZXIpO1xuXG4gICAgKHRoaXMgYXMgYW55KS5fZGV0YWlsUmlnaHQgPSB1bmRlZmluZWQ7XG4gICAgKHRoaXMgYXMgYW55KS5fcHJvZ2Vzc1dyYXBwZXIgPSB1bmRlZmluZWRcblxuICAgIGZvciAobGV0IGl0ZW0gb2YgdGhpcy5fbGVnZW5kSXRlbXMpIHtcbiAgICAgIHJlbW92ZShpdGVtKVxuICAgIH1cblxuICAgICh0aGlzIGFzIGFueSkuX2xlZ2VuZEl0ZW1zID0gdW5kZWZpbmVkO1xuICAgICh0aGlzIGFzIGFueSkuX2xlZ2VuZCA9IHVuZGVmaW5lZFxuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIHVzZSBkZXN0cm95KCkgaW5zdGVhZC5cbiAgICogQHRvZG8gcmVtb3ZlIGluIHZlcnNpb24gMi4wLjBcbiAgICovXG4gIHB1YmxpYyBkZXN0b3J5KCkge1xuICAgIHRoaXMuZGVzdHJveSgpXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGluaXQoKSB7XG4gIHNlYXJjaEFuZEluaXRpYWxpemU8SFRNTEVsZW1lbnQ+KFwiLmJhci1jaGFydC1ob3Jpem9udGFsXCIsIChlKSA9PiB7XG4gICAgbmV3IEJhckNoYXJ0SG9yaXpvbnRhbChlKVxuICB9KVxufVxuXG5leHBvcnQgZGVmYXVsdCBCYXJDaGFydEhvcml6b250YWxcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4vLi4ifQ==
