import * as tslib_1 from "tslib";
import DomElement from "../DomElement";
import { searchAndInitialize } from "../Utils";
import { text } from "../DomFunctions";
import { createLegendItem, isColor, removeAllChildren } from "./ChartFunctions";
import anime from "animejs";
var QUERY_DATA_CATEGORIES = ".js-data-list .js-category";
var QUERY_DATA_ITEMS = ".js-data-list .js-data";
var QUERY_CHART = ".js-chart";
var QUERY_LEGEND = ".bar-chart__legend";
var CLASS_INDICATOR = "indicator";
var CLASS_LABEL_X = "axis-x-label";
var CLASS_INDICATOR_WRAPPER = "indicator-wrapper";
var CLASS_INDICATOR_INNER_WRAPPER = "indicator-wrapper-inner";
var CLASS_INDICATOR_EMPTY = "empty";
var CLASS_TOOLTIP = "tooltip";
var CLASS_TOOLTIP_LEFT = "tooltip--left";
var CLASS_TOOLTIP_RIGHT = "tooltip--right";
var CLASS_TOOLTIP_MULTILINE = "tooltip--multiline";
var ANIMATION_DURATION = 500;
/**
 * Bar Chart Horizontal Component.
 */
var BarChartVertical = /** @class */ (function (_super) {
    tslib_1.__extends(BarChartVertical, _super);
    /**
     * Creates and initializes the bar chart horizontal component.
     * @param element - root element of the chart.
     * @param data - data for the chart.
     */
    function BarChartVertical(element, data) {
        var _this = _super.call(this, element) || this;
        if (data) {
            _this._data = data;
        }
        _this._initialize();
        return _this;
    }
    BarChartVertical.prototype._initialize = function () {
        this._unit = this.getAttribute("data-unit") || "";
        this._maxValue = parseFloat(this.getAttribute("data-max")) || 100;
        this._chart = this.element.querySelector(QUERY_CHART);
        this._legend = this.element.querySelector(QUERY_LEGEND);
        if (!this._data) {
            this._data = this._tryGetData(this.element);
        }
        this._render();
    };
    BarChartVertical.prototype._tryGetData = function (element) {
        var e_1, _a, e_2, _b, e_3, _c;
        var data = {
            categories: [],
            items: []
        };
        var categories = element.querySelectorAll(QUERY_DATA_CATEGORIES);
        var items = element.querySelectorAll(QUERY_DATA_ITEMS);
        try {
            for (var categories_1 = tslib_1.__values(categories), categories_1_1 = categories_1.next(); !categories_1_1.done; categories_1_1 = categories_1.next()) {
                var category = categories_1_1.value;
                data.categories.push({
                    title: text(category),
                    color: category.getAttribute("data-color")
                });
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (categories_1_1 && !categories_1_1.done && (_a = categories_1.return)) _a.call(categories_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        try {
            for (var items_1 = tslib_1.__values(items), items_1_1 = items_1.next(); !items_1_1.done; items_1_1 = items_1.next()) {
                var item = items_1_1.value;
                var dataEnty = {
                    title: text(item),
                    class: item.getAttribute("data-class"),
                    values: []
                };
                var vals = item.getAttribute("data-value");
                if (vals) {
                    try {
                        for (var _d = (e_3 = void 0, tslib_1.__values(vals.split(","))), _e = _d.next(); !_e.done; _e = _d.next()) {
                            var val = _e.value;
                            dataEnty.values.push(parseFloat(val));
                        }
                    }
                    catch (e_3_1) { e_3 = { error: e_3_1 }; }
                    finally {
                        try {
                            if (_e && !_e.done && (_c = _d.return)) _c.call(_d);
                        }
                        finally { if (e_3) throw e_3.error; }
                    }
                }
                data.items.push(dataEnty);
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (items_1_1 && !items_1_1.done && (_b = items_1.return)) _b.call(items_1);
            }
            finally { if (e_2) throw e_2.error; }
        }
        return data;
    };
    BarChartVertical.prototype._getTooltipContent = function (entry, categories) {
        var tooltip = "";
        for (var i = 0; i < entry.values.length; i++) {
            tooltip += categories[i].title + ": " + entry.values[i] + " " + this._unit + "\n";
        }
        return tooltip.trim();
    };
    BarChartVertical.prototype._render = function () {
        var e_4, _a, e_5, _b;
        if (this._legend) {
            removeAllChildren(this._legend);
            try {
                for (var _c = tslib_1.__values(this._data.categories), _d = _c.next(); !_d.done; _d = _c.next()) {
                    var category = _d.value;
                    var legendItem = createLegendItem(category);
                    this._legend.appendChild(legendItem);
                }
            }
            catch (e_4_1) { e_4 = { error: e_4_1 }; }
            finally {
                try {
                    if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
                }
                finally { if (e_4) throw e_4.error; }
            }
        }
        removeAllChildren(this._chart);
        var animationStages = [];
        var leftSideItems = Math.floor(this._data.items.length / 2);
        try {
            for (var _e = tslib_1.__values(this._data.items), _f = _e.next(); !_f.done; _f = _e.next()) {
                var item = _f.value;
                var element = new DomElement("li");
                if (item.class) {
                    element.addClass(item.class);
                }
                var listElement = new DomElement("ul")
                    .addClass(CLASS_INDICATOR_WRAPPER);
                var wrapper = new DomElement("div")
                    .addClass(CLASS_INDICATOR_INNER_WRAPPER);
                listElement.appendChild(wrapper);
                element.appendChild(listElement);
                var tooltip = this._getTooltipContent(item, this._data.categories);
                if (tooltip) {
                    wrapper
                        .addClass(CLASS_TOOLTIP)
                        .addClass(leftSideItems <= 0 ? CLASS_TOOLTIP_LEFT : CLASS_TOOLTIP_RIGHT)
                        .setAttribute("aria-label", tooltip);
                    if (item.values.length > 1) {
                        wrapper.addClass(CLASS_TOOLTIP_MULTILINE);
                    }
                }
                for (var i = 0; i < item.values.length; i++) {
                    var height = (this._chart.offsetHeight / this._maxValue) * item.values[i];
                    var indicator = new DomElement("li")
                        .addClass(CLASS_INDICATOR)
                        .setAttribute("style", "height: " + height + "px;");
                    if (height > 0) {
                        var color = this._data.categories[i].color;
                        if (isColor(color)) {
                            indicator.setAttribute("style", "background-color: " + color + ";");
                        }
                        else {
                            indicator.addClass(color);
                        }
                        if (animationStages.length <= i) {
                            animationStages.push([]);
                        }
                        animationStages[i].push(indicator.element);
                    }
                    else {
                        indicator.addClass(CLASS_INDICATOR_EMPTY);
                    }
                    wrapper.appendChild(indicator);
                }
                var titleDomElement = new DomElement("div")
                    .addClass(CLASS_LABEL_X);
                var titleElement = titleDomElement.element;
                titleElement.innerText = item.title;
                element.appendChild(titleDomElement);
                this._chart.appendChild(element.element);
                leftSideItems -= 1;
            }
        }
        catch (e_5_1) { e_5 = { error: e_5_1 }; }
        finally {
            try {
                if (_f && !_f.done && (_b = _e.return)) _b.call(_e);
            }
            finally { if (e_5) throw e_5.error; }
        }
        for (var i = 0; i < animationStages.length; i++) {
            var offset = ANIMATION_DURATION * i;
            this._animateBars(animationStages[i], offset);
            if (this._legend) {
                this._animateLegend(this._legend.children[i], offset);
            }
        }
    };
    BarChartVertical.prototype._animateBars = function (bars, animationOffset) {
        for (var i = 0; i < bars.length; i++) {
            var bar = bars[i];
            var barHeight = bar.style.height;
            bar.style.height = "0";
            anime({
                targets: bars[i],
                height: barHeight,
                easing: "easeInOutQuint",
                duration: ANIMATION_DURATION,
                delay: animationOffset
            });
        }
    };
    BarChartVertical.prototype._animateLegend = function (legend, animationOffset) {
        legend.style.opacity = "0";
        anime({
            targets: legend,
            opacity: 1,
            easing: "easeInOutQuint",
            duration: ANIMATION_DURATION,
            delay: animationOffset
        });
    };
    /**
     * Updates the bar chart with the specified data definitions.
     * @param {Array} - bar chart data definitions.
     */
    BarChartVertical.prototype.update = function (data) {
        if (data) {
            this._data = data;
        }
        this._render();
    };
    /**
     * Removes all event handlers and clears references.
     */
    BarChartVertical.prototype.destroy = function () {
        this._data = undefined;
        if (this._legend) {
            removeAllChildren(this._legend);
            this._legend = undefined;
        }
    };
    /**
     * @deprecated use destroy() instead.
     * @todo remove in version 2.0.0
     */
    BarChartVertical.prototype.destory = function () {
        this.destroy();
    };
    return BarChartVertical;
}(DomElement));
export function init() {
    searchAndInitialize(".bar-chart-vertical", function (e) {
        new BarChartVertical(e);
    });
}
export default BarChartVertical;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4vc3JjL2NoYXJ0cy9CYXJDaGFydFZlcnRpY2FsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLFVBQVUsTUFBTSxlQUFlLENBQUE7QUFDdEMsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQzlDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTtBQUN0QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsT0FBTyxFQUFFLGlCQUFpQixFQUFjLE1BQU0sa0JBQWtCLENBQUE7QUFFM0YsT0FBTyxLQUFLLE1BQU0sU0FBUyxDQUFBO0FBRTNCLElBQU0scUJBQXFCLEdBQUcsNEJBQTRCLENBQUE7QUFDMUQsSUFBTSxnQkFBZ0IsR0FBRyx3QkFBd0IsQ0FBQTtBQUNqRCxJQUFNLFdBQVcsR0FBRyxXQUFXLENBQUE7QUFDL0IsSUFBTSxZQUFZLEdBQUcsb0JBQW9CLENBQUE7QUFFekMsSUFBTSxlQUFlLEdBQUcsV0FBVyxDQUFBO0FBQ25DLElBQU0sYUFBYSxHQUFHLGNBQWMsQ0FBQTtBQUNwQyxJQUFNLHVCQUF1QixHQUFHLG1CQUFtQixDQUFBO0FBQ25ELElBQU0sNkJBQTZCLEdBQUcseUJBQXlCLENBQUE7QUFDL0QsSUFBTSxxQkFBcUIsR0FBRyxPQUFPLENBQUE7QUFFckMsSUFBTSxhQUFhLEdBQUcsU0FBUyxDQUFBO0FBQy9CLElBQU0sa0JBQWtCLEdBQUcsZUFBZSxDQUFBO0FBQzFDLElBQU0sbUJBQW1CLEdBQUcsZ0JBQWdCLENBQUE7QUFDNUMsSUFBTSx1QkFBdUIsR0FBRyxvQkFBb0IsQ0FBQTtBQUVwRCxJQUFNLGtCQUFrQixHQUFHLEdBQUcsQ0FBQTtBQWdCOUI7O0dBRUc7QUFDSDtJQUErQiw0Q0FBdUI7SUFTcEQ7Ozs7T0FJRztJQUNILDBCQUFZLE9BQW9CLEVBQUUsSUFBZ0I7UUFBbEQsWUFDRSxrQkFBTSxPQUFPLENBQUMsU0FPZjtRQUxDLElBQUksSUFBSSxFQUFFO1lBQ1IsS0FB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QUFBO0lBQ0osQ0FBQztJQUVEOzs7T0FHRztJQUNJLGlDQUFNLEdBQWIsVUFBYyxJQUFlO1FBQzNCLElBQUksSUFBSSxFQUFFO1lBQ1IsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUE7U0FDbEI7UUFFRCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDaEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksa0NBQU8sR0FBZDtRQUNHLElBQVksQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFBO1FBRS9CLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDL0IsSUFBWSxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUE7U0FDbEM7SUFDSCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksa0NBQU8sR0FBZDtRQUNFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUNoQixDQUFDO0lBQ0gsdUJBQUM7QUFBRCxDQXpPQSxBQXlPQyxDQXpPOEIsVUFBVSxHQXlPeEM7QUFFRCxNQUFNLFVBQVUsSUFBSTtJQUNsQixtQkFBbUIsQ0FBYyxxQkFBcUIsRUFBRSxVQUFDLENBQUM7UUFDeEQsSUFBSSxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUN6QixDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFFRCxlQUFlLGdCQUFnQixDQUFBIiwiZmlsZSI6Im1haW4vc3JjL2NoYXJ0cy9CYXJDaGFydFZlcnRpY2FsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IERvbUVsZW1lbnQgZnJvbSBcIi4uL0RvbUVsZW1lbnRcIlxuaW1wb3J0IHsgc2VhcmNoQW5kSW5pdGlhbGl6ZSB9IGZyb20gXCIuLi9VdGlsc1wiXG5pbXBvcnQgeyB0ZXh0IH0gZnJvbSBcIi4uL0RvbUZ1bmN0aW9uc1wiXG5pbXBvcnQgeyBjcmVhdGVMZWdlbmRJdGVtLCBpc0NvbG9yLCByZW1vdmVBbGxDaGlsZHJlbiwgQ2hhcnRMYWJlbCB9IGZyb20gXCIuL0NoYXJ0RnVuY3Rpb25zXCJcblxuaW1wb3J0IGFuaW1lIGZyb20gXCJhbmltZWpzXCJcblxuY29uc3QgUVVFUllfREFUQV9DQVRFR09SSUVTID0gXCIuanMtZGF0YS1saXN0IC5qcy1jYXRlZ29yeVwiXG5jb25zdCBRVUVSWV9EQVRBX0lURU1TID0gXCIuanMtZGF0YS1saXN0IC5qcy1kYXRhXCJcbmNvbnN0IFFVRVJZX0NIQVJUID0gXCIuanMtY2hhcnRcIlxuY29uc3QgUVVFUllfTEVHRU5EID0gXCIuYmFyLWNoYXJ0X19sZWdlbmRcIlxuXG5jb25zdCBDTEFTU19JTkRJQ0FUT1IgPSBcImluZGljYXRvclwiXG5jb25zdCBDTEFTU19MQUJFTF9YID0gXCJheGlzLXgtbGFiZWxcIlxuY29uc3QgQ0xBU1NfSU5ESUNBVE9SX1dSQVBQRVIgPSBcImluZGljYXRvci13cmFwcGVyXCJcbmNvbnN0IENMQVNTX0lORElDQVRPUl9JTk5FUl9XUkFQUEVSID0gXCJpbmRpY2F0b3Itd3JhcHBlci1pbm5lclwiXG5jb25zdCBDTEFTU19JTkRJQ0FUT1JfRU1QVFkgPSBcImVtcHR5XCJcblxuY29uc3QgQ0xBU1NfVE9PTFRJUCA9IFwidG9vbHRpcFwiXG5jb25zdCBDTEFTU19UT09MVElQX0xFRlQgPSBcInRvb2x0aXAtLWxlZnRcIlxuY29uc3QgQ0xBU1NfVE9PTFRJUF9SSUdIVCA9IFwidG9vbHRpcC0tcmlnaHRcIlxuY29uc3QgQ0xBU1NfVE9PTFRJUF9NVUxUSUxJTkUgPSBcInRvb2x0aXAtLW11bHRpbGluZVwiXG5cbmNvbnN0IEFOSU1BVElPTl9EVVJBVElPTiA9IDUwMFxuXG5leHBvcnQgaW50ZXJmYWNlIENhdGVnb3J5IGV4dGVuZHMgQ2hhcnRMYWJlbCB7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF0YUVudHJ5IHtcbiAgdGl0bGU6IHN0cmluZ1xuICBjbGFzczogc3RyaW5nXG4gIHZhbHVlczogbnVtYmVyW11cbn1cblxuZXhwb3J0IGludGVyZmFjZSBDaGFydERhdGEge1xuICBjYXRlZ29yaWVzOiBDYXRlZ29yeVtdXG4gIGl0ZW1zOiBEYXRhRW50cnlbXVxufVxuXG4vKipcbiAqIEJhciBDaGFydCBIb3Jpem9udGFsIENvbXBvbmVudC5cbiAqL1xuY2xhc3MgQmFyQ2hhcnRWZXJ0aWNhbCBleHRlbmRzIERvbUVsZW1lbnQ8SFRNTEVsZW1lbnQ+IHtcbiAgcHJpdmF0ZSBfZGF0YSE6IENoYXJ0RGF0YVxuXG4gIHByaXZhdGUgX3VuaXQhOiBzdHJpbmdcbiAgcHJpdmF0ZSBfbWF4VmFsdWUhOiBudW1iZXJcblxuICBwcml2YXRlIF9jaGFydCE6IEhUTUxFbGVtZW50XG4gIHByaXZhdGUgX2xlZ2VuZCE6IEhUTUxFbGVtZW50XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW5kIGluaXRpYWxpemVzIHRoZSBiYXIgY2hhcnQgaG9yaXpvbnRhbCBjb21wb25lbnQuXG4gICAqIEBwYXJhbSBlbGVtZW50IC0gcm9vdCBlbGVtZW50IG9mIHRoZSBjaGFydC5cbiAgICogQHBhcmFtIGRhdGEgLSBkYXRhIGZvciB0aGUgY2hhcnQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihlbGVtZW50OiBIVE1MRWxlbWVudCwgZGF0YT86IENoYXJ0RGF0YSkge1xuICAgIHN1cGVyKGVsZW1lbnQpXG5cbiAgICBpZiAoZGF0YSkge1xuICAgICAgdGhpcy5fZGF0YSA9IGRhdGFcbiAgICB9XG5cbiAgICB0aGlzLl9pbml0aWFsaXplKClcbiAgfVxuXG4gIHByb3RlY3RlZCBfaW5pdGlhbGl6ZSgpIHtcbiAgICB0aGlzLl91bml0ID0gdGhpcy5nZXRBdHRyaWJ1dGUoXCJkYXRhLXVuaXRcIikgfHwgXCJcIlxuXG4gICAgdGhpcy5fbWF4VmFsdWUgPSBwYXJzZUZsb2F0KHRoaXMuZ2V0QXR0cmlidXRlKFwiZGF0YS1tYXhcIikhKSB8fCAxMDBcblxuICAgIHRoaXMuX2NoYXJ0ID0gdGhpcy5lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoUVVFUllfQ0hBUlQpISBhcyBIVE1MRWxlbWVudFxuICAgIHRoaXMuX2xlZ2VuZCA9IHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yKFFVRVJZX0xFR0VORCkhIGFzIEhUTUxFbGVtZW50XG5cbiAgICBpZiAoIXRoaXMuX2RhdGEpIHtcbiAgICAgIHRoaXMuX2RhdGEgPSB0aGlzLl90cnlHZXREYXRhKHRoaXMuZWxlbWVudClcbiAgICB9XG5cbiAgICB0aGlzLl9yZW5kZXIoKVxuICB9XG5cbiAgcHJvdGVjdGVkIF90cnlHZXREYXRhKGVsZW1lbnQ6IEhUTUxFbGVtZW50KTogQ2hhcnREYXRhIHtcbiAgICBjb25zdCBkYXRhOiBDaGFydERhdGEgPSB7XG4gICAgICBjYXRlZ29yaWVzOiBbXSxcbiAgICAgIGl0ZW1zOiBbXVxuICAgIH1cblxuICAgIGNvbnN0IGNhdGVnb3JpZXMgPSBlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoUVVFUllfREFUQV9DQVRFR09SSUVTKVxuICAgIGNvbnN0IGl0ZW1zID0gZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKFFVRVJZX0RBVEFfSVRFTVMpXG5cbiAgICBmb3IgKGNvbnN0IGNhdGVnb3J5IG9mIGNhdGVnb3JpZXMpIHtcbiAgICAgIGRhdGEuY2F0ZWdvcmllcy5wdXNoKFxuICAgICAgICB7XG4gICAgICAgICAgdGl0bGU6IHRleHQoY2F0ZWdvcnkpLFxuICAgICAgICAgIGNvbG9yOiBjYXRlZ29yeS5nZXRBdHRyaWJ1dGUoXCJkYXRhLWNvbG9yXCIpIVxuICAgICAgICB9XG4gICAgICApXG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKSB7XG4gICAgICBjb25zdCBkYXRhRW50eTogRGF0YUVudHJ5ID0ge1xuICAgICAgICB0aXRsZTogdGV4dChpdGVtKSxcbiAgICAgICAgY2xhc3M6IGl0ZW0uZ2V0QXR0cmlidXRlKFwiZGF0YS1jbGFzc1wiKSEsXG4gICAgICAgIHZhbHVlczogW11cbiAgICAgIH1cblxuICAgICAgY29uc3QgdmFscyA9IGl0ZW0uZ2V0QXR0cmlidXRlKFwiZGF0YS12YWx1ZVwiKVxuICAgICAgaWYgKHZhbHMpIHtcbiAgICAgICAgZm9yIChjb25zdCB2YWwgb2YgdmFscy5zcGxpdChcIixcIikpIHtcbiAgICAgICAgICBkYXRhRW50eS52YWx1ZXMucHVzaChwYXJzZUZsb2F0KHZhbCkpXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZGF0YS5pdGVtcy5wdXNoKGRhdGFFbnR5KVxuICAgIH1cblxuICAgIHJldHVybiBkYXRhXG4gIH1cblxuICBwcm90ZWN0ZWQgX2dldFRvb2x0aXBDb250ZW50KGVudHJ5OiBEYXRhRW50cnksIGNhdGVnb3JpZXM6IENhdGVnb3J5W10pIHtcbiAgICBsZXQgdG9vbHRpcCA9IFwiXCJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVudHJ5LnZhbHVlcy5sZW5ndGg7IGkrKykge1xuICAgICAgdG9vbHRpcCArPSBgJHtjYXRlZ29yaWVzW2ldLnRpdGxlfTogJHtlbnRyeS52YWx1ZXNbaV19ICR7dGhpcy5fdW5pdH1cXG5gXG4gICAgfVxuXG4gICAgcmV0dXJuIHRvb2x0aXAudHJpbSgpXG4gIH1cblxuICBwcm90ZWN0ZWQgX3JlbmRlcigpIHtcbiAgICBpZiAodGhpcy5fbGVnZW5kKSB7XG4gICAgICByZW1vdmVBbGxDaGlsZHJlbih0aGlzLl9sZWdlbmQpXG5cbiAgICAgIGZvciAoY29uc3QgY2F0ZWdvcnkgb2YgdGhpcy5fZGF0YS5jYXRlZ29yaWVzKSB7XG4gICAgICAgIGNvbnN0IGxlZ2VuZEl0ZW0gPSBjcmVhdGVMZWdlbmRJdGVtKGNhdGVnb3J5KVxuICAgICAgICB0aGlzLl9sZWdlbmQuYXBwZW5kQ2hpbGQobGVnZW5kSXRlbSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZW1vdmVBbGxDaGlsZHJlbih0aGlzLl9jaGFydClcblxuICAgIGNvbnN0IGFuaW1hdGlvblN0YWdlczogRWxlbWVudFtdW10gPSBbXVxuXG4gICAgbGV0IGxlZnRTaWRlSXRlbXMgPSBNYXRoLmZsb29yKHRoaXMuX2RhdGEuaXRlbXMubGVuZ3RoIC8gMilcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdGhpcy5fZGF0YS5pdGVtcykge1xuICAgICAgbGV0IGVsZW1lbnQgPSBuZXcgRG9tRWxlbWVudChcImxpXCIpXG5cbiAgICAgIGlmIChpdGVtLmNsYXNzKSB7XG4gICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoaXRlbS5jbGFzcylcbiAgICAgIH1cblxuICAgICAgY29uc3QgbGlzdEVsZW1lbnQgPSBuZXcgRG9tRWxlbWVudChcInVsXCIpXG4gICAgICAgIC5hZGRDbGFzcyhDTEFTU19JTkRJQ0FUT1JfV1JBUFBFUilcblxuICAgICAgY29uc3Qgd3JhcHBlciA9IG5ldyBEb21FbGVtZW50KFwiZGl2XCIpXG4gICAgICAgIC5hZGRDbGFzcyhDTEFTU19JTkRJQ0FUT1JfSU5ORVJfV1JBUFBFUilcbiAgICAgIGxpc3RFbGVtZW50LmFwcGVuZENoaWxkKHdyYXBwZXIpXG5cbiAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQobGlzdEVsZW1lbnQpXG5cbiAgICAgIGNvbnN0IHRvb2x0aXAgPSB0aGlzLl9nZXRUb29sdGlwQ29udGVudChpdGVtLCB0aGlzLl9kYXRhLmNhdGVnb3JpZXMpXG4gICAgICBpZiAodG9vbHRpcCkge1xuICAgICAgICB3cmFwcGVyXG4gICAgICAgICAgLmFkZENsYXNzKENMQVNTX1RPT0xUSVApXG4gICAgICAgICAgLmFkZENsYXNzKGxlZnRTaWRlSXRlbXMgPD0gMCA/IENMQVNTX1RPT0xUSVBfTEVGVCA6IENMQVNTX1RPT0xUSVBfUklHSFQpXG4gICAgICAgICAgLnNldEF0dHJpYnV0ZShcImFyaWEtbGFiZWxcIiwgdG9vbHRpcClcblxuICAgICAgICBpZiAoaXRlbS52YWx1ZXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgIHdyYXBwZXIuYWRkQ2xhc3MoQ0xBU1NfVE9PTFRJUF9NVUxUSUxJTkUpXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVtLnZhbHVlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBoZWlnaHQgPSAodGhpcy5fY2hhcnQub2Zmc2V0SGVpZ2h0IC8gdGhpcy5fbWF4VmFsdWUpICogaXRlbS52YWx1ZXNbaV1cblxuICAgICAgICBjb25zdCBpbmRpY2F0b3IgPSBuZXcgRG9tRWxlbWVudChcImxpXCIpXG4gICAgICAgICAgLmFkZENsYXNzKENMQVNTX0lORElDQVRPUilcbiAgICAgICAgICAuc2V0QXR0cmlidXRlKFwic3R5bGVcIiwgYGhlaWdodDogJHtoZWlnaHR9cHg7YClcblxuICAgICAgICBpZiAoaGVpZ2h0ID4gMCkge1xuICAgICAgICAgIGNvbnN0IGNvbG9yID0gdGhpcy5fZGF0YS5jYXRlZ29yaWVzW2ldLmNvbG9yXG4gICAgICAgICAgaWYgKGlzQ29sb3IoY29sb3IpKSB7XG4gICAgICAgICAgICBpbmRpY2F0b3Iuc2V0QXR0cmlidXRlKFwic3R5bGVcIiwgYGJhY2tncm91bmQtY29sb3I6ICR7Y29sb3J9O2ApXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGluZGljYXRvci5hZGRDbGFzcyhjb2xvcilcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoYW5pbWF0aW9uU3RhZ2VzLmxlbmd0aCA8PSBpKSB7XG4gICAgICAgICAgICBhbmltYXRpb25TdGFnZXMucHVzaChbXSlcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBhbmltYXRpb25TdGFnZXNbaV0ucHVzaChpbmRpY2F0b3IuZWxlbWVudClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpbmRpY2F0b3IuYWRkQ2xhc3MoQ0xBU1NfSU5ESUNBVE9SX0VNUFRZKVxuICAgICAgICB9XG5cbiAgICAgICAgd3JhcHBlci5hcHBlbmRDaGlsZChpbmRpY2F0b3IpXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRpdGxlRG9tRWxlbWVudCA9IG5ldyBEb21FbGVtZW50KFwiZGl2XCIpXG4gICAgICAgIC5hZGRDbGFzcyhDTEFTU19MQUJFTF9YKVxuICAgICAgY29uc3QgdGl0bGVFbGVtZW50ID0gdGl0bGVEb21FbGVtZW50LmVsZW1lbnQgYXMgSFRNTEVsZW1lbnRcbiAgICAgIHRpdGxlRWxlbWVudC5pbm5lclRleHQgPSBpdGVtLnRpdGxlXG4gICAgICBlbGVtZW50LmFwcGVuZENoaWxkKHRpdGxlRG9tRWxlbWVudClcblxuICAgICAgdGhpcy5fY2hhcnQuYXBwZW5kQ2hpbGQoZWxlbWVudC5lbGVtZW50KVxuICAgICAgbGVmdFNpZGVJdGVtcyAtPSAxXG4gICAgfVxuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbmltYXRpb25TdGFnZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IG9mZnNldCA9IEFOSU1BVElPTl9EVVJBVElPTiAqIGlcbiAgICAgIHRoaXMuX2FuaW1hdGVCYXJzKGFuaW1hdGlvblN0YWdlc1tpXSBhcyBIVE1MRWxlbWVudFtdLCBvZmZzZXQpXG5cbiAgICAgIGlmICh0aGlzLl9sZWdlbmQpIHtcbiAgICAgICAgdGhpcy5fYW5pbWF0ZUxlZ2VuZCh0aGlzLl9sZWdlbmQuY2hpbGRyZW5baV0gYXMgSFRNTEVsZW1lbnQsIG9mZnNldClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9hbmltYXRlQmFycyhiYXJzOiBIVE1MRWxlbWVudFtdLCBhbmltYXRpb25PZmZzZXQ6IG51bWJlcikge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmFycy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgYmFyID0gYmFyc1tpXVxuICAgICAgY29uc3QgYmFySGVpZ2h0ID0gYmFyLnN0eWxlLmhlaWdodFxuICAgICAgYmFyLnN0eWxlLmhlaWdodCA9IFwiMFwiXG4gICAgICBhbmltZSh7XG4gICAgICAgIHRhcmdldHM6IGJhcnNbaV0sXG4gICAgICAgIGhlaWdodDogYmFySGVpZ2h0LFxuICAgICAgICBlYXNpbmc6IFwiZWFzZUluT3V0UXVpbnRcIixcbiAgICAgICAgZHVyYXRpb246IEFOSU1BVElPTl9EVVJBVElPTixcbiAgICAgICAgZGVsYXk6IGFuaW1hdGlvbk9mZnNldFxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9hbmltYXRlTGVnZW5kKGxlZ2VuZDogSFRNTEVsZW1lbnQsIGFuaW1hdGlvbk9mZnNldDogbnVtYmVyKSB7XG4gICAgbGVnZW5kLnN0eWxlLm9wYWNpdHkgPSBcIjBcIlxuICAgIGFuaW1lKHtcbiAgICAgIHRhcmdldHM6IGxlZ2VuZCxcbiAgICAgIG9wYWNpdHk6IDEsXG4gICAgICBlYXNpbmc6IFwiZWFzZUluT3V0UXVpbnRcIixcbiAgICAgIGR1cmF0aW9uOiBBTklNQVRJT05fRFVSQVRJT04sXG4gICAgICBkZWxheTogYW5pbWF0aW9uT2Zmc2V0XG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSBiYXIgY2hhcnQgd2l0aCB0aGUgc3BlY2lmaWVkIGRhdGEgZGVmaW5pdGlvbnMuXG4gICAqIEBwYXJhbSB7QXJyYXl9IC0gYmFyIGNoYXJ0IGRhdGEgZGVmaW5pdGlvbnMuXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlKGRhdGE6IENoYXJ0RGF0YSkge1xuICAgIGlmIChkYXRhKSB7XG4gICAgICB0aGlzLl9kYXRhID0gZGF0YVxuICAgIH1cblxuICAgIHRoaXMuX3JlbmRlcigpXG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBhbGwgZXZlbnQgaGFuZGxlcnMgYW5kIGNsZWFycyByZWZlcmVuY2VzLlxuICAgKi9cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgKHRoaXMgYXMgYW55KS5fZGF0YSA9IHVuZGVmaW5lZFxuXG4gICAgaWYgKHRoaXMuX2xlZ2VuZCkge1xuICAgICAgcmVtb3ZlQWxsQ2hpbGRyZW4odGhpcy5fbGVnZW5kKTtcbiAgICAgICh0aGlzIGFzIGFueSkuX2xlZ2VuZCA9IHVuZGVmaW5lZFxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCB1c2UgZGVzdHJveSgpIGluc3RlYWQuXG4gICAqIEB0b2RvIHJlbW92ZSBpbiB2ZXJzaW9uIDIuMC4wXG4gICAqL1xuICBwdWJsaWMgZGVzdG9yeSgpIHtcbiAgICB0aGlzLmRlc3Ryb3koKVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbml0KCkge1xuICBzZWFyY2hBbmRJbml0aWFsaXplPEhUTUxFbGVtZW50PihcIi5iYXItY2hhcnQtdmVydGljYWxcIiwgKGUpID0+IHtcbiAgICBuZXcgQmFyQ2hhcnRWZXJ0aWNhbChlKVxuICB9KVxufVxuXG5leHBvcnQgZGVmYXVsdCBCYXJDaGFydFZlcnRpY2FsXG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uLy4uIn0=
