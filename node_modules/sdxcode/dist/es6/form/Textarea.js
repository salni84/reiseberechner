import * as tslib_1 from "tslib";
import { searchAndInitialize } from "../Utils";
import DomElement from "../DomElement";
import * as Dom from "../DomFunctions";
var QUERY_TEXTAREA = "textarea";
var CLASS_HAS_VALUE = "is-fixed";
/**
 * Textarea component
 */
var Textarea = /** @class */ (function (_super) {
    tslib_1.__extends(Textarea, _super);
    function Textarea(element) {
        var _this = _super.call(this, element) || this;
        _this._area = _this.element.querySelector(QUERY_TEXTAREA);
        _this._focusChangedHandler = _this._focusChanged.bind(_this);
        _this._valueChangedHandler = _this._onValueChanged.bind(_this);
        _this._resizeHandler = _this._updateHeight.bind(_this);
        _this._initialize();
        return _this;
    }
    /**
     * Initializes the textarea component.
     * @private
     */
    Textarea.prototype._initialize = function () {
        this._minRows = parseInt(this._area.getAttribute("data-min-rows") || "3", 10);
        this._maxRows = parseInt(this._area.getAttribute("data-max-rows"), 10) || Number.MAX_SAFE_INTEGER;
        // Make sure min an max are property specified
        this._minRows = Math.min(this._minRows, this._maxRows);
        this._maxRows = Math.max(this._minRows, this._maxRows);
        this._lineHeight = parseInt(Dom.css(this._area, "line-height"), 10);
        this._updateBaseHeight = Dom.isHidden(this._area, true);
        this._calculateBaseHeight();
        // add event listeners
        this._area.addEventListener("focus", this._focusChangedHandler);
        this._area.addEventListener("blur", this._focusChangedHandler);
        this._area.addEventListener("input", this._valueChangedHandler);
        window.addEventListener("resize", this._resizeHandler);
        window.addEventListener("orientationchange", this._resizeHandler);
        this._onValueChanged();
    };
    Textarea.prototype._calculateBaseHeight = function () {
        // temporary clear the content to take measurements
        var value = this._area.value;
        this._area.value = "";
        this._baseHeight = this._area.offsetHeight - this._lineHeight;
        this._baseScrollHeight = this._area.scrollHeight - this._lineHeight;
        // restore initial content
        this._area.value = value;
    };
    Textarea.prototype._focusChanged = function () {
        this._updateHeight();
    };
    Textarea.prototype._updateHeight = function () {
        var hasFocus = this._area === document.activeElement;
        var maxRows, rows = 0;
        if (this._updateBaseHeight === true && Dom.isHidden(this._area, true) === false) {
            this._calculateBaseHeight();
            this._updateBaseHeight = false;
        }
        // Calculate the apropriate size for the control
        if (!this._hasValue()) {
            // Handle empty states
            rows = hasFocus === true ? this._minRows : 1;
            maxRows = rows;
        }
        else {
            // Reset the height for calculation of the row count
            this._area.style.height = "auto";
            // Get the new height
            rows = Math.ceil((this._area.scrollHeight - this._baseScrollHeight) / this._lineHeight) + 1;
            maxRows = Math.max(Math.min(this._maxRows, rows), this._minRows);
        }
        if (rows > this._maxRows) {
            this._area.style.overflow = "auto";
        }
        else {
            this._area.style.overflow = "hidden";
        }
        var height = ((maxRows - 1) * this._lineHeight) + this._baseHeight;
        this._area.style.height = height + "px";
    };
    Textarea.prototype._hasValue = function () {
        return this._area.value && this._area.value.length > 0;
    };
    Textarea.prototype._onValueChanged = function () {
        if (this._hasValue()) {
            Dom.addClass(this._area, CLASS_HAS_VALUE);
        }
        else {
            Dom.removeClass(this._area, CLASS_HAS_VALUE);
            this._area.value = "";
        }
        this._updateHeight();
    };
    /**
     * Destroys the component and clears all references.
     */
    Textarea.prototype.destroy = function () {
        window.removeEventListener("resize", this._resizeHandler);
        window.removeEventListener("orientationchange", this._resizeHandler);
        this._area.removeEventListener("focus", this._focusChangedHandler);
        this._area.removeEventListener("blur", this._focusChangedHandler);
        this._area.removeEventListener("input", this._valueChangedHandler);
        this._focusChangedHandler = null;
        this._valueChangedHander = null;
        this._area = null;
        this._minRows = null;
        this._maxRows = null;
        this._lineHeight = null;
        this._baseHeight = null;
        this._baseScrollHeight = null;
        this.element = null;
    };
    return Textarea;
}(DomElement));
export function init() {
    searchAndInitialize(".input-multiline, .input-field--multiline", function (e) {
        new Textarea(e);
    });
}
export default Textarea;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4vc3JjL2Zvcm0vVGV4dGFyZWEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUM5QyxPQUFPLFVBQVUsTUFBTSxlQUFlLENBQUE7QUFDdEMsT0FBTyxLQUFLLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQTtBQUV0QyxJQUFNLGNBQWMsR0FBRyxVQUFVLENBQUE7QUFDakMsSUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFBO0FBRWxDOztHQUVHO0FBQ0g7SUFBdUIsb0NBQVU7SUFnQi9CLGtCQUFZLE9BQWdCO1FBQTVCLFlBQ0Usa0JBQU0sT0FBTyxDQUFDLFNBU2Y7UUFQQyxLQUFJLENBQUMsS0FBSyxHQUFHLEtBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBRSxDQUFBO1FBRXhELEtBQUksQ0FBQyxvQkFBb0IsR0FBRyxLQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFJLENBQUMsQ0FBQTtRQUN6RCxLQUFJLENBQUMsb0JBQW9CLEdBQUcsS0FBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLENBQUE7UUFDM0QsS0FBSSxDQUFDLGNBQWMsR0FBRyxLQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFJLENBQUMsQ0FBQTtRQUVuRCxLQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7O0lBQ3BCLENBQUM7SUFFRDs7O09BR0c7SUFDTyw4QkFBVyxHQUFyQjtRQUNFLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUM3RSxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUUsRUFBRSxFQUFFLENBQUMsSUFBSSxNQUFNLENBQUMsZ0JBQWdCLENBQUE7UUFFbEcsOENBQThDO1FBQzlDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUN0RCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7UUFFdEQsSUFBSSxDQUFDLFdBQVcsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLGFBQWEsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBRW5FLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDdkQsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUE7UUFFM0Isc0JBQXNCO1FBQ3RCLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO1FBQy9ELElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO1FBQzlELElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO1FBRS9ELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFBO1FBQ3RELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUE7UUFFakUsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFBO0lBQ3hCLENBQUM7SUFFUyx1Q0FBb0IsR0FBOUI7UUFDRSxtREFBbUQ7UUFDbkQsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUE7UUFDNUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFBO1FBRXJCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQTtRQUM3RCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQTtRQUVuRSwwQkFBMEI7UUFDMUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO0lBQzFCLENBQUM7SUFFUyxnQ0FBYSxHQUF2QjtRQUNFLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtJQUN0QixDQUFDO0lBRVMsZ0NBQWEsR0FBdkI7UUFDRSxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxLQUFLLFFBQVEsQ0FBQyxhQUFhLENBQUE7UUFDcEQsSUFBSSxPQUFPLEVBQUUsSUFBSSxHQUFHLENBQUMsQ0FBQTtRQUVyQixJQUFJLElBQUksQ0FBQyxpQkFBaUIsS0FBSyxJQUFJLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEtBQUssRUFBRTtZQUMvRSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQTtZQUMzQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFBO1NBQy9CO1FBRUQsZ0RBQWdEO1FBQ2hELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUU7WUFDckIsc0JBQXNCO1lBQ3RCLElBQUksR0FBRyxRQUFRLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDNUMsT0FBTyxHQUFHLElBQUksQ0FBQTtTQUNmO2FBQU07WUFDTCxvREFBb0Q7WUFDcEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQTtZQUVoQyxxQkFBcUI7WUFDckIsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQzNGLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7U0FDakU7UUFFRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUE7U0FDbkM7YUFBTTtZQUNMLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUE7U0FDckM7UUFFRCxJQUFNLE1BQU0sR0FBRyxDQUFDLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFBO1FBQ3BFLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBTSxNQUFNLE9BQUksQ0FBQTtJQUN6QyxDQUFDO0lBRVMsNEJBQVMsR0FBbkI7UUFDRSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7SUFDeEQsQ0FBQztJQUVTLGtDQUFlLEdBQXpCO1FBQ0UsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUU7WUFDcEIsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLGVBQWUsQ0FBQyxDQUFBO1NBQzFDO2FBQU07WUFDTCxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsZUFBZSxDQUFDLENBQUE7WUFDNUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFBO1NBQ3RCO1FBRUQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO0lBQ3RCLENBQUM7SUFFRDs7T0FFRztJQUNJLDBCQUFPLEdBQWQ7UUFDRSxNQUFNLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQTtRQUN6RCxNQUFNLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFBO1FBRXBFLElBQUksQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO1FBQ2xFLElBQUksQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO1FBQ2pFLElBQUksQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBRWxFLElBQVksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUM7UUFDekMsSUFBWSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQztRQUN4QyxJQUFZLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUMxQixJQUFZLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUM3QixJQUFZLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUM3QixJQUFZLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUNoQyxJQUFZLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUNoQyxJQUFZLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO1FBQ3RDLElBQVksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFBO0lBQzlCLENBQUM7SUFDSCxlQUFDO0FBQUQsQ0E3SUEsQUE2SUMsQ0E3SXNCLFVBQVUsR0E2SWhDO0FBRUQsTUFBTSxVQUFVLElBQUk7SUFDbEIsbUJBQW1CLENBQUMsMkNBQTJDLEVBQUUsVUFBQyxDQUFDO1FBQ2pFLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2pCLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQUVELGVBQWUsUUFBUSxDQUFBIiwiZmlsZSI6Im1haW4vc3JjL2Zvcm0vVGV4dGFyZWEuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzZWFyY2hBbmRJbml0aWFsaXplIH0gZnJvbSBcIi4uL1V0aWxzXCJcbmltcG9ydCBEb21FbGVtZW50IGZyb20gXCIuLi9Eb21FbGVtZW50XCJcbmltcG9ydCAqIGFzIERvbSBmcm9tIFwiLi4vRG9tRnVuY3Rpb25zXCJcblxuY29uc3QgUVVFUllfVEVYVEFSRUEgPSBcInRleHRhcmVhXCJcbmNvbnN0IENMQVNTX0hBU19WQUxVRSA9IFwiaXMtZml4ZWRcIlxuXG4vKipcbiAqIFRleHRhcmVhIGNvbXBvbmVudFxuICovXG5jbGFzcyBUZXh0YXJlYSBleHRlbmRzIERvbUVsZW1lbnQge1xuICBwcml2YXRlIF9hcmVhOiBIVE1MVGV4dEFyZWFFbGVtZW50XG5cbiAgcHJpdmF0ZSBfZm9jdXNDaGFuZ2VkSGFuZGxlcjogKGU6IEV2ZW50KSA9PiB2b2lkXG4gIHByaXZhdGUgX3ZhbHVlQ2hhbmdlZEhhbmRsZXI6IChlOiBFdmVudCkgPT4gdm9pZFxuICBwcml2YXRlIF9yZXNpemVIYW5kbGVyOiAoZTogRXZlbnQpID0+IHZvaWRcblxuICBwcml2YXRlIF9taW5Sb3dzITogbnVtYmVyXG4gIHByaXZhdGUgX21heFJvd3MhOiBudW1iZXJcbiAgcHJpdmF0ZSBfbGluZUhlaWdodCE6IG51bWJlclxuXG4gIHByaXZhdGUgX3VwZGF0ZUJhc2VIZWlnaHQhOiBib29sZWFuXG5cbiAgcHJpdmF0ZSBfYmFzZUhlaWdodCE6IG51bWJlclxuICBwcml2YXRlIF9iYXNlU2Nyb2xsSGVpZ2h0ITogbnVtYmVyXG5cbiAgY29uc3RydWN0b3IoZWxlbWVudDogRWxlbWVudCkge1xuICAgIHN1cGVyKGVsZW1lbnQpXG5cbiAgICB0aGlzLl9hcmVhID0gdGhpcy5lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoUVVFUllfVEVYVEFSRUEpIVxuXG4gICAgdGhpcy5fZm9jdXNDaGFuZ2VkSGFuZGxlciA9IHRoaXMuX2ZvY3VzQ2hhbmdlZC5iaW5kKHRoaXMpXG4gICAgdGhpcy5fdmFsdWVDaGFuZ2VkSGFuZGxlciA9IHRoaXMuX29uVmFsdWVDaGFuZ2VkLmJpbmQodGhpcylcbiAgICB0aGlzLl9yZXNpemVIYW5kbGVyID0gdGhpcy5fdXBkYXRlSGVpZ2h0LmJpbmQodGhpcylcblxuICAgIHRoaXMuX2luaXRpYWxpemUoKVxuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemVzIHRoZSB0ZXh0YXJlYSBjb21wb25lbnQuXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBwcm90ZWN0ZWQgX2luaXRpYWxpemUoKSB7XG4gICAgdGhpcy5fbWluUm93cyA9IHBhcnNlSW50KHRoaXMuX2FyZWEuZ2V0QXR0cmlidXRlKFwiZGF0YS1taW4tcm93c1wiKSB8fCBcIjNcIiwgMTApXG4gICAgdGhpcy5fbWF4Um93cyA9IHBhcnNlSW50KHRoaXMuX2FyZWEuZ2V0QXR0cmlidXRlKFwiZGF0YS1tYXgtcm93c1wiKSEsIDEwKSB8fCBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUlxuXG4gICAgLy8gTWFrZSBzdXJlIG1pbiBhbiBtYXggYXJlIHByb3BlcnR5IHNwZWNpZmllZFxuICAgIHRoaXMuX21pblJvd3MgPSBNYXRoLm1pbih0aGlzLl9taW5Sb3dzLCB0aGlzLl9tYXhSb3dzKVxuICAgIHRoaXMuX21heFJvd3MgPSBNYXRoLm1heCh0aGlzLl9taW5Sb3dzLCB0aGlzLl9tYXhSb3dzKVxuXG4gICAgdGhpcy5fbGluZUhlaWdodCA9IHBhcnNlSW50KERvbS5jc3ModGhpcy5fYXJlYSwgXCJsaW5lLWhlaWdodFwiKSwgMTApXG5cbiAgICB0aGlzLl91cGRhdGVCYXNlSGVpZ2h0ID0gRG9tLmlzSGlkZGVuKHRoaXMuX2FyZWEsIHRydWUpXG4gICAgdGhpcy5fY2FsY3VsYXRlQmFzZUhlaWdodCgpXG5cbiAgICAvLyBhZGQgZXZlbnQgbGlzdGVuZXJzXG4gICAgdGhpcy5fYXJlYS5hZGRFdmVudExpc3RlbmVyKFwiZm9jdXNcIiwgdGhpcy5fZm9jdXNDaGFuZ2VkSGFuZGxlcilcbiAgICB0aGlzLl9hcmVhLmFkZEV2ZW50TGlzdGVuZXIoXCJibHVyXCIsIHRoaXMuX2ZvY3VzQ2hhbmdlZEhhbmRsZXIpXG4gICAgdGhpcy5fYXJlYS5hZGRFdmVudExpc3RlbmVyKFwiaW5wdXRcIiwgdGhpcy5fdmFsdWVDaGFuZ2VkSGFuZGxlcilcblxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwicmVzaXplXCIsIHRoaXMuX3Jlc2l6ZUhhbmRsZXIpXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJvcmllbnRhdGlvbmNoYW5nZVwiLCB0aGlzLl9yZXNpemVIYW5kbGVyKVxuXG4gICAgdGhpcy5fb25WYWx1ZUNoYW5nZWQoKVxuICB9XG5cbiAgcHJvdGVjdGVkIF9jYWxjdWxhdGVCYXNlSGVpZ2h0KCkge1xuICAgIC8vIHRlbXBvcmFyeSBjbGVhciB0aGUgY29udGVudCB0byB0YWtlIG1lYXN1cmVtZW50c1xuICAgIGxldCB2YWx1ZSA9IHRoaXMuX2FyZWEudmFsdWVcbiAgICB0aGlzLl9hcmVhLnZhbHVlID0gXCJcIlxuXG4gICAgdGhpcy5fYmFzZUhlaWdodCA9IHRoaXMuX2FyZWEub2Zmc2V0SGVpZ2h0IC0gdGhpcy5fbGluZUhlaWdodFxuICAgIHRoaXMuX2Jhc2VTY3JvbGxIZWlnaHQgPSB0aGlzLl9hcmVhLnNjcm9sbEhlaWdodCAtIHRoaXMuX2xpbmVIZWlnaHRcblxuICAgIC8vIHJlc3RvcmUgaW5pdGlhbCBjb250ZW50XG4gICAgdGhpcy5fYXJlYS52YWx1ZSA9IHZhbHVlXG4gIH1cblxuICBwcm90ZWN0ZWQgX2ZvY3VzQ2hhbmdlZCgpIHtcbiAgICB0aGlzLl91cGRhdGVIZWlnaHQoKVxuICB9XG5cbiAgcHJvdGVjdGVkIF91cGRhdGVIZWlnaHQoKSB7XG4gICAgbGV0IGhhc0ZvY3VzID0gdGhpcy5fYXJlYSA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudFxuICAgIGxldCBtYXhSb3dzLCByb3dzID0gMFxuXG4gICAgaWYgKHRoaXMuX3VwZGF0ZUJhc2VIZWlnaHQgPT09IHRydWUgJiYgRG9tLmlzSGlkZGVuKHRoaXMuX2FyZWEsIHRydWUpID09PSBmYWxzZSkge1xuICAgICAgdGhpcy5fY2FsY3VsYXRlQmFzZUhlaWdodCgpXG4gICAgICB0aGlzLl91cGRhdGVCYXNlSGVpZ2h0ID0gZmFsc2VcbiAgICB9XG5cbiAgICAvLyBDYWxjdWxhdGUgdGhlIGFwcm9wcmlhdGUgc2l6ZSBmb3IgdGhlIGNvbnRyb2xcbiAgICBpZiAoIXRoaXMuX2hhc1ZhbHVlKCkpIHtcbiAgICAgIC8vIEhhbmRsZSBlbXB0eSBzdGF0ZXNcbiAgICAgIHJvd3MgPSBoYXNGb2N1cyA9PT0gdHJ1ZSA/IHRoaXMuX21pblJvd3MgOiAxXG4gICAgICBtYXhSb3dzID0gcm93c1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBSZXNldCB0aGUgaGVpZ2h0IGZvciBjYWxjdWxhdGlvbiBvZiB0aGUgcm93IGNvdW50XG4gICAgICB0aGlzLl9hcmVhLnN0eWxlLmhlaWdodCA9IFwiYXV0b1wiXG5cbiAgICAgIC8vIEdldCB0aGUgbmV3IGhlaWdodFxuICAgICAgcm93cyA9IE1hdGguY2VpbCgodGhpcy5fYXJlYS5zY3JvbGxIZWlnaHQgLSB0aGlzLl9iYXNlU2Nyb2xsSGVpZ2h0KSAvIHRoaXMuX2xpbmVIZWlnaHQpICsgMVxuICAgICAgbWF4Um93cyA9IE1hdGgubWF4KE1hdGgubWluKHRoaXMuX21heFJvd3MsIHJvd3MpLCB0aGlzLl9taW5Sb3dzKVxuICAgIH1cblxuICAgIGlmIChyb3dzID4gdGhpcy5fbWF4Um93cykge1xuICAgICAgdGhpcy5fYXJlYS5zdHlsZS5vdmVyZmxvdyA9IFwiYXV0b1wiXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2FyZWEuc3R5bGUub3ZlcmZsb3cgPSBcImhpZGRlblwiXG4gICAgfVxuXG4gICAgY29uc3QgaGVpZ2h0ID0gKChtYXhSb3dzIC0gMSkgKiB0aGlzLl9saW5lSGVpZ2h0KSArIHRoaXMuX2Jhc2VIZWlnaHRcbiAgICB0aGlzLl9hcmVhLnN0eWxlLmhlaWdodCA9IGAke2hlaWdodH1weGBcbiAgfVxuXG4gIHByb3RlY3RlZCBfaGFzVmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FyZWEudmFsdWUgJiYgdGhpcy5fYXJlYS52YWx1ZS5sZW5ndGggPiAwXG4gIH1cblxuICBwcm90ZWN0ZWQgX29uVmFsdWVDaGFuZ2VkKCkge1xuICAgIGlmICh0aGlzLl9oYXNWYWx1ZSgpKSB7XG4gICAgICBEb20uYWRkQ2xhc3ModGhpcy5fYXJlYSwgQ0xBU1NfSEFTX1ZBTFVFKVxuICAgIH0gZWxzZSB7XG4gICAgICBEb20ucmVtb3ZlQ2xhc3ModGhpcy5fYXJlYSwgQ0xBU1NfSEFTX1ZBTFVFKVxuICAgICAgdGhpcy5fYXJlYS52YWx1ZSA9IFwiXCJcbiAgICB9XG5cbiAgICB0aGlzLl91cGRhdGVIZWlnaHQoKVxuICB9XG5cbiAgLyoqXG4gICAqIERlc3Ryb3lzIHRoZSBjb21wb25lbnQgYW5kIGNsZWFycyBhbGwgcmVmZXJlbmNlcy5cbiAgICovXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFwicmVzaXplXCIsIHRoaXMuX3Jlc2l6ZUhhbmRsZXIpXG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJvcmllbnRhdGlvbmNoYW5nZVwiLCB0aGlzLl9yZXNpemVIYW5kbGVyKVxuXG4gICAgdGhpcy5fYXJlYS5yZW1vdmVFdmVudExpc3RlbmVyKFwiZm9jdXNcIiwgdGhpcy5fZm9jdXNDaGFuZ2VkSGFuZGxlcilcbiAgICB0aGlzLl9hcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJibHVyXCIsIHRoaXMuX2ZvY3VzQ2hhbmdlZEhhbmRsZXIpXG4gICAgdGhpcy5fYXJlYS5yZW1vdmVFdmVudExpc3RlbmVyKFwiaW5wdXRcIiwgdGhpcy5fdmFsdWVDaGFuZ2VkSGFuZGxlcik7XG5cbiAgICAodGhpcyBhcyBhbnkpLl9mb2N1c0NoYW5nZWRIYW5kbGVyID0gbnVsbDtcbiAgICAodGhpcyBhcyBhbnkpLl92YWx1ZUNoYW5nZWRIYW5kZXIgPSBudWxsO1xuICAgICh0aGlzIGFzIGFueSkuX2FyZWEgPSBudWxsO1xuICAgICh0aGlzIGFzIGFueSkuX21pblJvd3MgPSBudWxsO1xuICAgICh0aGlzIGFzIGFueSkuX21heFJvd3MgPSBudWxsO1xuICAgICh0aGlzIGFzIGFueSkuX2xpbmVIZWlnaHQgPSBudWxsO1xuICAgICh0aGlzIGFzIGFueSkuX2Jhc2VIZWlnaHQgPSBudWxsO1xuICAgICh0aGlzIGFzIGFueSkuX2Jhc2VTY3JvbGxIZWlnaHQgPSBudWxsO1xuICAgICh0aGlzIGFzIGFueSkuZWxlbWVudCA9IG51bGxcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5pdCgpIHtcbiAgc2VhcmNoQW5kSW5pdGlhbGl6ZShcIi5pbnB1dC1tdWx0aWxpbmUsIC5pbnB1dC1maWVsZC0tbXVsdGlsaW5lXCIsIChlKSA9PiB7XG4gICAgbmV3IFRleHRhcmVhKGUpXG4gIH0pXG59XG5cbmV4cG9ydCBkZWZhdWx0IFRleHRhcmVhXG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uLy4uIn0=
